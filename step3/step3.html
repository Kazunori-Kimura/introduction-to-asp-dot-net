<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>introduction to asp dot net - ASP.NET勉強会</title>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <!-- highlightjs -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
  <!-- font-awesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <style>
    /* Sticky footer styles
    -------------------------------------------------- */
    html {
      position: relative;
      min-height: 100%;
    }
    body {
      padding-top: 70px;
      /* Margin bottom by footer height */
      margin-bottom: 70px;
    }
    .footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      /* Set the fixed height of the footer here */
      height: 60px;
      background-color: #f5f5f5;
    }
    /* Custom page CSS
    -------------------------------------------------- */
    /* Not required for template or sticky footer method. */
    .container {
      width: auto;
      max-width: 980px;
      padding: 0 15px;
    }
    .contents p, .contents li {
      font-size: large;
      line-height: 180%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 20px;
      margin-bottom: 15px;
    }
    .container .text-muted {
      margin: 20px 0;
    }
    .ad-block {
      width: auto;
      max-width: 768px;
    }
  </style>
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://kazunori-kimura.github.io/introduction-to-asp-dot-net/">introduction to asp dot net</a>
      </div>
      <p class="navbar-text navbar-right">
        <a href="https://github.com/Kazunori-Kimura/introduction-to-asp-dot-net" class="navbar-link" target="_blank">
          <i class="fa fa-github"></i>
          View on GitHub
        </a>
      </p>
    </div>
  </nav>

  <div class="container contents">
    <!-- contents -->
    <h1 id="4-asp-net-web-api-rest-api-">4. <code>ASP.NET Web API</code>によるREST API開発</h1>
<h2 id="web-api-">Web API とは？</h2>
<ul>
<li><code>API</code>: Application Programming Interface<ul>
<li>あるプログラムが提供する機能を、 <em>外部の別のプログラム</em> から呼び出して利用するための手法</li>
</ul>
</li>
</ul>
<p>プログラムからのHTTPリクエストに対し、<code>XML</code> や <code>JSON</code> などのデータを返すWebアプリケーションを <em>Web API</em> と呼びます。</p>
<p><br></p>
<h3 id="web-api-">Web API のメリットは？</h3>
<ul>
<li>HTTP が使用できるものであれば、どのようなクライアントからも利用できる<ul>
<li>Webブラウザ向けのシステムをモバイル向けに作り直す、といった時も Web API は変更しなくてよい</li>
<li>複数のWeb APIを組み合わせたシステムを開発することも可能 (マッシュアップ)</li>
</ul>
</li>
<li>クライアントサイドのプログラムと完全に分断して開発できる<ul>
<li>システムの役割が明確になり、より良い設計になる (ことが期待できる)</li>
</ul>
</li>
</ul>
<p><br></p>
<h2 id="-rest-"><code>REST</code> とは？</h2>
<ul>
<li>Web API のソフトウェアアーキテクチャのスタイルのひとつ。<ul>
<li>REST の原則に従っているシステムは <code>RESTful</code>なシステム、 といわれます。</li>
<li>REST をとても熱心に支持する <em>RESTafarians</em> と呼ばれる人たちがいます。<br>このような人たちに、適当な設計のWebアプリケーションを「REST APIです」と紹介すると、すごいマサカリが飛んできます。</li>
</ul>
</li>
</ul>
<h3 id="-">原則</h3>
<ul>
<li>ステートレスなクライアント/サーバープロトコル</li>
</ul>
<p>セッションやクッキーによるセッション状態の管理を行わず、
一度のリクエスト/レスポンスで問い合わせが完了する。</p>
<ul>
<li><code>URI (Uniform Resource Identifier)</code> でリソースを一意に識別する</li>
</ul>
<p><code>http://{webapi}/user/1/task/5</code> のような URL にリクエストを投げると
<code>userId</code>が<code>1</code>のユーザーが持っている<code>taskId</code>が<code>5</code>のタスク情報を返すようなイメージ。</p>
<ul>
<li>HTTPメソッドでリソースを操作する</li>
</ul>
<table>
<thead>
<tr>
<th>HTTPメソッド</th>
<th>リソースの操作</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>リソースの取得 (Read)</td>
</tr>
<tr>
<td>POST</td>
<td>リソースの追加 (Create)</td>
</tr>
<tr>
<td>PUT</td>
<td>リソースの更新 (Update)</td>
</tr>
<tr>
<td>DELETE</td>
<td>リソースの削除 (Delete)</td>
</tr>
</tbody>
</table>
<ul>
<li>操作の結果は HTTPのステータスコードで返す</li>
</ul>
<table>
<thead>
<tr>
<th>ステータスコード</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>200</td>
<td>OK</td>
</tr>
<tr>
<td>201</td>
<td>Created</td>
</tr>
<tr>
<td>400</td>
<td>Bad Request</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden</td>
</tr>
<tr>
<td>404</td>
<td>Not Found</td>
</tr>
<tr>
<td>500</td>
<td>Internal Server Error</td>
</tr>
</tbody>
</table>
<p><br></p>
<hr>
<p><br></p>
<h2 id="getting-started-with-asp-net-web-api">Getting Started with ASP.NET Web API</h2>
<p>参考: <a href="http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/tutorial-your-first-web-api">Getting Started with ASP.NET Web API 2</a></p>
<p><br></p>
<h3 id="-">クライアント環境のインストール</h3>
<p>今回はクライアント側のプログラムは作成しないので、Web APIに問い合わせを行う
クライアントアプリケーションを用意します。</p>
<p>HTTPが喋れるツールであれば何でも良いのですが、今回は <code>cURL</code> を使用します。</p>
<h4 id="curl">cURL</h4>
<blockquote>
<p>cURL（カール）は、さまざまなプロトコルを用いてデータを転送するライブラリとコマンドラインツールを提供するプロジェクトである。</p>
<p><a href="http://ja.wikipedia.org/wiki/CURL">cURL</a></p>
</blockquote>
<h4 id="chocolatey">Chocolatey</h4>
<p>自分で<code>cURL</code>のバイナリを探してきてダウンロード・インストールするのは面倒臭いので、
パッケージ管理ツールを使用します。</p>
<p><a href="https://chocolatey.org/">Chocolatey</a> は <code>apt-get</code> のようなパッケージ管理ツールです。
(<code>Chocolatey</code> の背後では NuGet が動いているようです。)</p>
<p>コマンドプロンプトを <code>管理者として実行</code> し、以下のコマンドをコピー&amp;ペーストします。</p>
<pre><code class="lang-bat"><span class="hljs-variable">@powershell</span> -NoProfile -ExecutionPolicy unrestricted -Command <span class="hljs-string">"iex ((new-object net.webclient).DownloadString('https://chocolatey.org/install.ps1'))"</span> &amp;&amp; SET PATH=<span class="hljs-variable">%PATH</span><span class="hljs-variable">%;</span><span class="hljs-variable">%ALLUSERSPROFILE</span><span class="hljs-variable">%\</span>chocolatey\bin
</code></pre>
<h4 id="curl-">cURLのインストール</h4>
<p><code>Chocolatey</code> を使用して、<code>cURL</code>をインストールします。</p>
<pre><code class="lang-bat">choco <span class="hljs-keyword">install</span> curl
</code></pre>
<p><img src="./images/WS000014.JPG" alt="cURLのインストール"></p>
<h4 id="-">動作確認</h4>
<p><code>www.example.com</code>のhtmlを取得してみます。</p>
<pre><code class="lang-bat">&gt;curl http://www.example.com
<span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>Example Domain<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"utf-8"</span> /&gt;</span>
    :
</code></pre>
<p>きちんとhtmlが返ってくれば、準備完了です。</p>
<p><br></p>
<hr>
<p><br></p>
<h3 id="-web-api-">作成するWeb APIの仕様</h3>
<ul>
<li>ToDo管理API</li>
</ul>
<table>
<thead>
<tr>
<th>操作</th>
<th>URL</th>
<th>Method</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Create</td>
<td>/api/Todoes/</td>
<td>post</td>
<td>1件作成</td>
</tr>
<tr>
<td>Read</td>
<td>/api/Todoes/{id}</td>
<td>get</td>
<td>指定したTodoを取得</td>
</tr>
<tr>
<td>ReadAll</td>
<td>/api/Todoes/</td>
<td>get</td>
<td>全てのTodoを取得</td>
</tr>
<tr>
<td>Update</td>
<td>/api/Todoes/{id}</td>
<td>put</td>
<td>指定したTodoを更新</td>
</tr>
<tr>
<td>Delete</td>
<td>/api/Todoes/{id}</td>
<td>delete</td>
<td>指定したTodoを削除</td>
</tr>
</tbody>
</table>
<h4 id="todo-">Todoリストの項目</h4>
<ul>
<li>id: Todoを一意に特定する数値。</li>
<li>summary: 概要。文字列。</li>
<li>detail: 詳細。文字列。</li>
<li>limit: 期限。日時。</li>
<li><p>done: 完了フラグ。真偽値。</p>
<p>  前回作成した MVC の Todo管理アプリケーションと同じ内容です。</p>
</li>
</ul>
<hr>
<h3 id="-">開発手順</h3>
<h4 id="-">プロジェクトの作成</h4>
<ul>
<li>新しいプロジェクトの作成<ul>
<li>名前は <code>TodoApi</code> とします。</li>
</ul>
</li>
</ul>
<p><img src="./images/WS000000.JPG" alt="新しいプロジェクト"></p>
<ul>
<li>テンプレートは <code>Empty</code>を選択し、<code>Web API</code>にチェックを入れます。</li>
</ul>
<p><img src="./images/WS000001.JPG" alt="新規 ASP.NET プロジェクト"></p>
<p><br></p>
<h4 id="entityframework-">EntityFrameworkを追加</h4>
<ul>
<li>プロジェクトを右クリック→「NuGet パッケージの管理」</li>
</ul>
<p><img src="./images/WS000002.JPG" alt="NuGet パッケージの管理-1"></p>
<ul>
<li>EntityFrameworkを選択して「インストール」</li>
</ul>
<p><img src="./images/WS000003.JPG" alt="NuGet パッケージの管理-2"></p>
<p><br></p>
<h4 id="model-">Modelクラスの追加</h4>
<ul>
<li><code>Models</code>を右クリック→「追加」→「クラス」を選択</li>
</ul>
<p><img src="./images/WS000005.JPG" alt="Todoクラスの追加-1"></p>
<ul>
<li>名前を <code>Todo.cs</code> として「追加」</li>
</ul>
<p><img src="./images/WS000006.JPG" alt="Todoクラスの追加-2"></p>
<p><code>Todo.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Web;

<span class="hljs-class"><span class="hljs-keyword">namespace</span> <span class="hljs-title">TodoApi</span>.<span class="hljs-title">Models</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Todo</span>
    </span>{
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> summary { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> detail { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> DateTime limit { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> done { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    }
}
</code></pre>
<ul>
<li>続いて <code>TodoesContext.cs</code> を追加</li>
</ul>
<p><code>TodoesContext.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Data.Entity;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Web;

<span class="hljs-class"><span class="hljs-keyword">namespace</span> <span class="hljs-title">TodoApi</span>.<span class="hljs-title">Models</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TodoesContext</span> : <span class="hljs-title">DbContext</span>
    </span>{
        <span class="hljs-keyword">public</span> DbSet&lt;Todo&gt; Todoes { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    }
}
</code></pre>
<p>ここまで作成したら、一旦ソリューション全体をビルドする。</p>
<p><br></p>
<h4 id="controller-">Controllerクラスの追加</h4>
<ul>
<li>Controllersを右クリック→「追加」→「コントローラー」を選択</li>
</ul>
<p><img src="./images/WS000007.JPG" alt="コントローラーの追加-1"></p>
<ul>
<li><code>Entity Framework を使用したアクションがある Web API 2 コントローラー</code> を選択して「追加」をクリック</li>
</ul>
<p><img src="./images/WS000008.JPG" alt="コントローラーの追加-2"></p>
<ul>
<li>モデル クラスに <code>Todo</code>、データ コンテキスト クラスに <code>TodoesContext</code> を選択して「追加」をクリック<ul>
<li>コントローラー名は自動で <code>TodoesController</code> となるはず</li>
<li>Model 作成時にビルドを実行していない場合、ここでエラーが発生します。</li>
</ul>
</li>
</ul>
<p><img src="./images/WS000009.JPG" alt="コントローラーの追加-3"></p>
<ul>
<li>以下の様なコードが自動生成されます。</li>
</ul>
<p><code>TodoesController.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Data;
<span class="hljs-keyword">using</span> System.Data.Entity;
<span class="hljs-keyword">using</span> System.Data.Entity.Infrastructure;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Net;
<span class="hljs-keyword">using</span> System.Net.Http;
<span class="hljs-keyword">using</span> System.Web.Http;
<span class="hljs-keyword">using</span> System.Web.Http.Description;
<span class="hljs-keyword">using</span> TodoApi.Models;

<span class="hljs-keyword">namespace</span> TodoApi.Controllers
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> TodoesController : ApiController
    {
        <span class="hljs-keyword">private</span> TodoesContext db = <span class="hljs-keyword">new</span> TodoesContext();

        <span class="hljs-comment">// GET: api/Todoes</span>
        <span class="hljs-keyword">public</span> IQueryable&lt;Todo&gt; GetTodoes()
        {
            <span class="hljs-keyword">return</span> db.Todoes;
        }

        <span class="hljs-comment">// GET: api/Todoes/5</span>
        [ResponseType(typeof(Todo))]
        <span class="hljs-function"><span class="hljs-keyword">public</span> IHttpActionResult <span class="hljs-title">GetTodo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span>
        </span>{
            Todo todo = db.Todoes.Find(id);
            <span class="hljs-keyword">if</span> (todo == null)
            {
                <span class="hljs-keyword">return</span> NotFound();
            }

            <span class="hljs-keyword">return</span> Ok(todo);
        }

        <span class="hljs-comment">// PUT: api/Todoes/5</span>
        [ResponseType(typeof(<span class="hljs-keyword">void</span>))]
        <span class="hljs-function"><span class="hljs-keyword">public</span> IHttpActionResult <span class="hljs-title">PutTodo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, Todo todo)</span>
        </span>{
            <span class="hljs-keyword">if</span> (!ModelState.IsValid)
            {
                <span class="hljs-keyword">return</span> BadRequest(ModelState);
            }

            <span class="hljs-keyword">if</span> (id != todo.id)
            {
                <span class="hljs-keyword">return</span> BadRequest();
            }

            db.Entry(todo).State = EntityState.Modified;

            <span class="hljs-keyword">try</span>
            {
                db.SaveChanges();
            }
            <span class="hljs-keyword">catch</span> (DbUpdateConcurrencyException)
            {
                <span class="hljs-keyword">if</span> (!TodoExists(id))
                {
                    <span class="hljs-keyword">return</span> NotFound();
                }
                <span class="hljs-keyword">else</span>
                {
                    <span class="hljs-keyword">throw</span>;
                }
            }

            <span class="hljs-keyword">return</span> StatusCode(HttpStatusCode.NoContent);
        }

        <span class="hljs-comment">// POST: api/Todoes</span>
        [ResponseType(typeof(Todo))]
        <span class="hljs-function"><span class="hljs-keyword">public</span> IHttpActionResult <span class="hljs-title">PostTodo</span><span class="hljs-params">(Todo todo)</span>
        </span>{
            <span class="hljs-keyword">if</span> (!ModelState.IsValid)
            {
                <span class="hljs-keyword">return</span> BadRequest(ModelState);
            }

            db.Todoes.Add(todo);
            db.SaveChanges();

            <span class="hljs-keyword">return</span> CreatedAtRoute(<span class="hljs-string">"DefaultApi"</span>, <span class="hljs-keyword">new</span> { id = todo.id }, todo);
        }

        <span class="hljs-comment">// DELETE: api/Todoes/5</span>
        [ResponseType(typeof(Todo))]
        <span class="hljs-function"><span class="hljs-keyword">public</span> IHttpActionResult <span class="hljs-title">DeleteTodo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span>
        </span>{
            Todo todo = db.Todoes.Find(id);
            <span class="hljs-keyword">if</span> (todo == null)
            {
                <span class="hljs-keyword">return</span> NotFound();
            }

            db.Todoes.Remove(todo);
            db.SaveChanges();

            <span class="hljs-keyword">return</span> Ok(todo);
        }

        <span class="hljs-function"><span class="hljs-keyword">protected</span> override <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> disposing)</span>
        </span>{
            <span class="hljs-keyword">if</span> (disposing)
            {
                db.Dispose();
            }
            base.Dispose(disposing);
        }

        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">TodoExists</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span>
        </span>{
            <span class="hljs-keyword">return</span> db.Todoes.Count(e =&gt; e.id == id) &gt; <span class="hljs-number">0</span>;
        }
    }
}
</code></pre>
<p>Web APIとして公開されるメソッドは <code>Public</code> になっています。</p>
<p>また、それぞれの命名規則は <code>HTTPメソッド名 + Model名</code> となっています。</p>
<h4 id="-">動作確認</h4>
<p>Visual Studioで F5キーを押下 (あるいは <code>|&gt;</code>ボタンをクリック) してデバッグ実行します。</p>
<p>ブラウザが起動しますが、Webページは用意していないのでエラー画面が表示されると思います。
Web API は正常に稼働しているはずです。 (動作確認を完了するまでブラウザは終了せず、そのままにしておいてください。)</p>
<ul>
<li>curlコマンドを使用して、Web APIにリクエストを投げます。</li>
</ul>
<pre><code class="lang-sh"># get all items
curl http:<span class="hljs-comment">//localhost:49192/api/Todoes/</span>

# create item
curl -v -<span class="hljs-keyword">H</span> <span class="hljs-string">"Content-Type: application/json"</span> -<span class="hljs-keyword">H</span> <span class="hljs-string">"Accept:application/json"</span> -X <span class="hljs-keyword">POST</span> -<span class="hljs-keyword">d</span> <span class="hljs-string">"{\"</span>summary\<span class="hljs-string">":\"</span><span class="hljs-keyword">test</span>\<span class="hljs-string">",\"</span>detail\<span class="hljs-string">":\"</span>hogehoge\<span class="hljs-string">",\"</span>limit\<span class="hljs-string">":\"</span>2015-02-01\<span class="hljs-string">",\"</span>done\<span class="hljs-string">":\"</span>false\<span class="hljs-string">"}"</span> http:<span class="hljs-comment">//localhost:49192/api/Todoes/</span>

# get item
curl http:<span class="hljs-comment">//localhost:49192/api/Todoes/1</span>

# <span class="hljs-keyword">update</span> item
curl -v -<span class="hljs-keyword">H</span> <span class="hljs-string">"Content-Type: application/json"</span> -<span class="hljs-keyword">H</span> <span class="hljs-string">"Accept:application/json"</span> -X PUT -<span class="hljs-keyword">d</span> <span class="hljs-string">"{\"</span>id\<span class="hljs-string">":5,\"</span>summary\<span class="hljs-string">":\"</span>test2\<span class="hljs-string">",\"</span>detail\<span class="hljs-string">":\"</span>hogehoge\<span class="hljs-string">",\"</span>limit\<span class="hljs-string">":\"</span>2015-02-01\<span class="hljs-string">",\"</span>done\<span class="hljs-string">":\"</span>false\<span class="hljs-string">"}"</span> http:<span class="hljs-comment">//localhost:49192/api/Todoes/5</span>
</code></pre>
<h3 id="-1-">補足(1) 絞り込み機能の追加</h3>
<p>現状、<code>http://localhost:49192/api/Todoes/</code> にリクエストを投げると全件返ってきます。</p>
<p>URLにパラメータ (<code>QueryString</code>といいます) を付与することで、Todoを絞り込めるように機能を追加してみます。</p>
<p><code>GetTodoes</code>を拡張し、引数にパラメータを取得するように指定します。</p>
<pre><code class="lang-cs"><span class="hljs-comment">// GET: api/Todoes</span>
<span class="hljs-keyword">public</span> IQueryable&lt;Todo&gt; GetTodoes([FromUri] Todo param)
{
    <span class="hljs-keyword">var</span> todoes = db.Todoes.OrderBy(item =&gt; item.id).Select(item =&gt; item);

    <span class="hljs-keyword">if</span> (!string.IsNullOrEmpty(param.summary))
    {
        <span class="hljs-comment">// summary検索</span>
        todoes = todoes.Where(item =&gt; item.summary.Contains(param.summary));
    }
    <span class="hljs-keyword">if</span> (param.done)
    {
        <span class="hljs-comment">// 完了フラグ</span>
        todoes = todoes.Where(item =&gt; <span class="hljs-keyword">true</span>.Equals(item.done));
    }

    <span class="hljs-keyword">return</span> todoes;
}
</code></pre>
<ul>
<li><p><code>[FromUri]</code> は <code>QueryString</code>の内容を引数にセットする指定です。</p>
</li>
<li><p><code>Select</code>, <code>OrderBy</code>, <code>Where</code> は <code>クエリ ビルダー メソッド</code> と言われるメソッドで <code>DbSet</code> (ここでは <code>db.Todoes</code>) のデータをフィルタリングしたり、並べ替えたりする際に使用します。</p>
<ul>
<li><a href="https://msdn.microsoft.com/ja-jp/library/cc716755(v=vs.100">データをフィルター選択する方法 (Entity Framework)</a>.aspx)</li>
</ul>
</li>
</ul>
<p><code>http://localhost:49192/api/Todoes/?summary=test&amp;done=false</code> といったようにURLパラメータに絞り込み条件を付与すると、条件に一致した項目のみ返ってきます。</p>
<p><br></p>
<h3 id="-2-">補足(2) データの格納場所について</h3>
<p>これまでの処理で登録されたデータは、<code>SQL Server LocalDB</code> に保存されています。</p>
<p>以下の手順で、登録されたデータを確認することができます。</p>
<ul>
<li><code>Web.config</code> に登録されている LocalDB のインスタンス名を確認します。</li>
</ul>
<pre><code class="lang-xml">  :
  <span class="hljs-tag">&lt;<span class="hljs-title">entityFramework</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">defaultConnectionFactory</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"System.Data.Entity.Infrastructure.LocalDbConnectionFactory, EntityFramework"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">parameters</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">parameter</span> <span class="hljs-attribute">value</span>=<span class="hljs-value">"mssqllocaldb"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">parameters</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">defaultConnectionFactory</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">providers</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">provider</span> <span class="hljs-attribute">invariantName</span>=<span class="hljs-value">"System.Data.SqlClient"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">providers</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">entityFramework</span>&gt;</span>
</code></pre>
<ul>
<li><code>mssqllocaldb</code> がインスタンス名です。</li>
<li>Visual Studio にて <code>表示</code> &gt; <code>SQL Server オブジェクト エクスプローラー</code> を選択します。</li>
<li><code>SQL Serverの追加</code> をクリックします。</li>
<li>サーバー名に <code>(localdb)\mssqllocaldb</code> と入力し、接続します。</li>
<li>「データベース」フォルダに <code>TodoApi.Models.TodoesContext</code> というデータベースが存在します。<ul>
<li><code>テーブル &gt; dbo.Todoes</code> を右クリックし、「データの表示」を選択します。</li>
</ul>
</li>
</ul>
<p>正常に接続できない場合は、以下の手順でインスタンス名を確認します。</p>
<ul>
<li>コマンドプロンプトを起動します。</li>
<li><code>&gt;sqllocaldb i</code> と入力します。<ul>
<li>インスタンスの一覧が表示されます。</li>
<li><code>SQL Server オブジェクト エクスプローラー</code> で各インスタンスの中身を確認してください。</li>
</ul>
</li>
</ul>
<p><br>
<br></p>
<hr>
<p><br></p>
<p>ASP.NET Web APIの開発手順について解説しました。</p>
<p><code>ASP.NET Web API</code> と <code>EntityFramework</code> により、以下のようなメリットがあることを実感いただけたのではないでしょうか。</p>
<ul>
<li>基本的な CRUD については Modelクラスの定義のみで生成できる</li>
<li>少しのコード追加で機能拡張ができる</li>
<li>データベースの準備なしにコーディングが開始できる</li>
</ul>
<p>次回は 今回作成したAPIを操作する WebアプリケーションのView部分を作成します。</p>
  </div>

  <br>
  <br>

  <div class="container">
    <div class="center-block ad-block">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- aaa-768x90 -->
      <ins class="adsbygoogle"
           style="display:inline-block;width:728px;height:90px"
           data-ad-client="ca-pub-5886049398949171"
           data-ad-slot="8568248344"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="text-muted">ASP.NET勉強会 , &copy; 2015 Kazunori Kimura</p>
    </div>
  </footer>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>
  $(function(){
    $(".contents table").addClass("table");
  });
  </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29149079-3', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
