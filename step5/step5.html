<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>introduction to asp dot net - ASP.NET勉強会</title>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <!-- highlightjs -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
  <!-- font-awesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <style>
    /* Sticky footer styles
    -------------------------------------------------- */
    html {
      position: relative;
      min-height: 100%;
    }
    body {
      padding-top: 70px;
      /* Margin bottom by footer height */
      margin-bottom: 70px;
    }
    .footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      /* Set the fixed height of the footer here */
      height: 60px;
      background-color: #f5f5f5;
    }
    /* Custom page CSS
    -------------------------------------------------- */
    /* Not required for template or sticky footer method. */
    .container {
      width: auto;
      max-width: 980px;
      padding: 0 15px;
    }
    .contents p, .contents li {
      font-size: large;
      line-height: 180%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 20px;
      margin-bottom: 15px;
    }
    .container .text-muted {
      margin: 20px 0;
    }
    .ad-block {
      width: auto;
      max-width: 768px;
    }
  </style>
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://kazunori-kimura.github.io/introduction-to-asp-dot-net/">introduction to asp dot net</a>
      </div>
      <p class="navbar-text navbar-right">
        <a href="https://github.com/Kazunori-Kimura/introduction-to-asp-dot-net" class="navbar-link" target="_blank">
          <i class="fa fa-github"></i>
          View on GitHub
        </a>
      </p>
    </div>
  </nav>

  <div class="container contents">
    <!-- contents -->
    <h1 id="-asp-net-web-api-knockout-js-single-page-application-2-"><code>ASP.NET Web API</code>と<code>knockout.js</code>によるSingle Page Application開発 (2)</h1>
<p><a href="../step4/step4.3.html">前回</a> は <em>Knockout.js</em> を使用して
ブラウザだけで動作するTodoアプリケーションを作成しました。</p>
<p>今回はサーバー側の処理を実装し、前回作成したフロントエンドと結合します。</p>
<p><br><br></p>
<h2 id="web-api-">Web API の作成</h2>
<p><a href="../step3/step3.html">以前</a> 取り上げた <em>ASP.NET Web API</em> の開発手順と全く同じです。</p>
<p><br><br></p>
<h3 id="-1-entityframework-">(1) EntityFrameworkを追加</h3>
<ul>
<li>プロジェクトを右クリック→「NuGet パッケージの管理」</li>
<li><em>EntityFramework</em> を選択して「インストール」</li>
</ul>
<p><br><br></p>
<h3 id="-2-model-">(2) Modelクラスの追加</h3>
<ul>
<li><code>Models</code>を右クリック→「追加」→「クラス」を選択します。</li>
<li>名前を <code>Todo.cs</code> として「追加」します。</li>
</ul>
<p><code>Todo.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Web;

<span class="hljs-class"><span class="hljs-keyword">namespace</span> <span class="hljs-title">TodoApi</span>.<span class="hljs-title">Models</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Todo</span>
    </span>{
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        [Required]
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> summary { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> detail { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        <span class="hljs-keyword">public</span> DateTime limit { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> done { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    }
}
</code></pre>
<ul>
<li>続いて <code>TodoesContext.cs</code> を追加します。</li>
</ul>
<p><code>TodoesContext.cs</code></p>
<pre><code class="lang-cs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Data.Entity;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Web;

<span class="hljs-class"><span class="hljs-keyword">namespace</span> <span class="hljs-title">TodoApi</span>.<span class="hljs-title">Models</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TodoesContext</span> : <span class="hljs-title">DbContext</span>
    </span>{
        <span class="hljs-keyword">public</span> DbSet&lt;Todo&gt; Todoes { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    }
}
</code></pre>
<p>ここまで作成したら、一旦ソリューション全体をビルドしてください。</p>
<p><br><br></p>
<h3 id="-3-controller-">(3) Controllerクラスの追加</h3>
<ul>
<li>Controllersを右クリック→「追加」→「コントローラー」を選択</li>
<li><code>Entity Framework を使用したアクションがある Web API 2 コントローラー</code> を選択して「追加」をクリック</li>
<li>モデル クラスに <code>Todo</code>、データ コンテキスト クラスに <code>TodoesContext</code> を選択して「追加」をクリック<ul>
<li>コントローラー名は自動で <code>TodoesController</code> となるはず</li>
</ul>
</li>
</ul>
<p>以下の様なメソッドが定義されます。</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>URL</th>
<th>Method</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Create</td>
<td>/api/Todoes/</td>
<td>post</td>
<td>1件作成</td>
</tr>
<tr>
<td>Read</td>
<td>/api/Todoes/{id}</td>
<td>get</td>
<td>指定したTodoを取得</td>
</tr>
<tr>
<td>ReadAll</td>
<td>/api/Todoes/</td>
<td>get</td>
<td>全てのTodoを取得</td>
</tr>
<tr>
<td>Update</td>
<td>/api/Todoes/{id}</td>
<td>put</td>
<td>指定したTodoを更新</td>
</tr>
<tr>
<td>Delete</td>
<td>/api/Todoes/{id}</td>
<td>delete</td>
<td>指定したTodoを削除</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>これで、サーバーサイドの実装は完了しました。</p>
<p><br><br></p>
<h2 id="-">フロントエンドとの結合</h2>
<p>今回作成したサーバーサイドの Web API と <a href="../step4/step4.3.html">前回</a> 作成した
フロントエンドをくっつけます。</p>
<p><br></p>
<h3 id="-1-todo-">(1) 初期表示時にTodoリストを表示する</h3>
<p>画面の読み込み完了後、非同期にて、<em>GET</em> メソッドで <code>/api/Todoes/</code> に問い合わせを行います。</p>
<p>サーバーから取得したTodoのリストを <em>observableArray</em> にセットします。</p>
<p><code>Scripts/app.js</code></p>
<pre><code class="lang-js"><span class="hljs-comment">// app.js</span>

<span class="hljs-comment">/**
 * Todo Model
 *<span class="hljs-phpdoc"> @param</span> 初期値 {object}
 */</span>
<span class="hljs-keyword">var</span> ToDoModel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(params)</span> </span>{ ... };

<span class="hljs-comment">/**
 * modal dialog model
 */</span>
<span class="hljs-keyword">var</span> DialogModel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ ... };

<span class="hljs-comment">/**
 * ViewModel
 */</span>
<span class="hljs-keyword">var</span> AppViewModel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;

    <span class="hljs-comment">/* ~~ 省略 ~~ */</span>

    <span class="hljs-comment">/**
     * Todoをすべて取得する
     */</span>
    <span class="hljs-keyword">self</span>.loadList = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        $.ajax({
            url: <span class="hljs-string">"/api/Todoes"</span>,
            dataType: <span class="hljs-string">"json"</span>,
            method: <span class="hljs-string">"GET"</span>
        })
            .done(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
                <span class="hljs-keyword">if</span> (data) {
                    <span class="hljs-comment">// 一旦全削除</span>
                    <span class="hljs-keyword">self</span>.todoList.removeAll();

                    <span class="hljs-comment">// 取得したTodoをリストにセット</span>
                    $.each(data, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(index, item)</span> </span>{
                        <span class="hljs-comment">// yyyy-mm-ddThh:mm:ss という形式で送られてくるので、</span>
                        <span class="hljs-comment">// 不要な "T" 以降をカット</span>
                        item.limit = item.limit.split(<span class="hljs-string">"T"</span>)[<span class="hljs-number">0</span>];
                        <span class="hljs-keyword">if</span> (item.limit == <span class="hljs-string">"1960-01-01"</span>) {
                            <span class="hljs-comment">// ダミーの日付の場合はブランクに置き換える</span>
                            item.limit = <span class="hljs-string">""</span>;
                        }
                        <span class="hljs-keyword">self</span>.todoList.push(<span class="hljs-keyword">new</span> ToDoModel(item));
                    });
                }
            });
    };
};

<span class="hljs-comment">// エントリポイント</span>
$(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> AppViewModel();
    ko.applyBindings(app);

    app.loadList();
});
</code></pre>
<p>日付の処理に少し工夫が必要です。</p>
<p>サーバーから送られてくる値は <code>yyyy-MM-ddTHH:mm:ss</code> という形式になっています。
今回は日付のみが必要なので、 不要な部分をカットして表示しています。</p>
<p><br><br></p>
<h3 id="-2-todo-todo-">(2) 新しいTodoを追加する / Todoの更新を行う</h3>
<p>追加の場合、登録ボタンクリック時に 非同期にて <em>POST</em> メソッドで <code>/api/Todoes/</code> に問い合わせを行います。</p>
<p>更新の場合、登録ボタンクリック時に 非同期にて <em>PUT</em> メソッドで <code>/api/Todoes/{id}</code> に問い合わせを行います。</p>
<p>登録に成功したら、フォームを非表示にして Todoリストを再取得します。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * 登録ボタンのクリック
 */</span>
<span class="hljs-built_in">self</span><span class="hljs-built_in">.</span>registTodo <span class="hljs-subst">=</span> function () {
    <span class="hljs-built_in">var</span> item <span class="hljs-subst">=</span> <span class="hljs-built_in">self</span><span class="hljs-built_in">.</span>selectedItem();

    <span class="hljs-comment">// limitが空だとサーバーサイドでエラーとなるため</span>
    <span class="hljs-comment">// ダミーの日付を登録する</span>
    <span class="hljs-built_in">var</span> model <span class="hljs-subst">=</span> ko<span class="hljs-built_in">.</span>toJS(item);
    <span class="hljs-keyword">if</span> (model<span class="hljs-built_in">.</span>limit <span class="hljs-subst">==</span> <span class="hljs-string">""</span>) {
        model<span class="hljs-built_in">.</span>limit <span class="hljs-subst">=</span> <span class="hljs-string">"1960-01-01"</span>;
    }

    <span class="hljs-comment">// ajaxのパラメータ</span>
    <span class="hljs-built_in">var</span> <span class="hljs-keyword">params</span> <span class="hljs-subst">=</span> {
        dataType: <span class="hljs-string">"json"</span>,
        <span class="hljs-built_in">data</span>: model
    };

    <span class="hljs-keyword">if</span> (item<span class="hljs-built_in">.</span>id() <span class="hljs-subst">==</span> <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// Create</span>
        <span class="hljs-keyword">params</span><span class="hljs-built_in">.</span>url <span class="hljs-subst">=</span> <span class="hljs-string">"/api/Todoes"</span>;
        <span class="hljs-keyword">params</span><span class="hljs-built_in">.</span>method <span class="hljs-subst">=</span> <span class="hljs-string">"POST"</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Update</span>
        <span class="hljs-keyword">params</span><span class="hljs-built_in">.</span>url <span class="hljs-subst">=</span> <span class="hljs-string">"/api/Todoes/"</span> <span class="hljs-subst">+</span> item<span class="hljs-built_in">.</span>id();
        <span class="hljs-keyword">params</span><span class="hljs-built_in">.</span>method <span class="hljs-subst">=</span> <span class="hljs-string">"PUT"</span>;
    }

    $<span class="hljs-built_in">.</span>ajax(<span class="hljs-keyword">params</span>)
        <span class="hljs-built_in">.</span>done(function (<span class="hljs-built_in">data</span>) {
            <span class="hljs-comment">// 編集フォームを閉じる</span>
            <span class="hljs-built_in">self</span><span class="hljs-built_in">.</span>selectedItem(<span class="hljs-built_in">null</span>);

            <span class="hljs-comment">// Todoリストを再読み込み</span>
            <span class="hljs-built_in">self</span><span class="hljs-built_in">.</span>loadList();

            <span class="hljs-built_in">self</span><span class="hljs-built_in">.</span>dialog<span class="hljs-built_in">.</span>show({
                title: <span class="hljs-string">'登録完了'</span>,
                message: <span class="hljs-string">'登録が完了しました。'</span>
            });
        });
};
</code></pre>
<p><br></p>
<p><em>jQuery</em> の <code>ajax</code> メソッドで、入力されたデータを <em>POST/PUT</em> します。</p>
<p><em>TodoModel</em> には <em>observable</em> のプロパティがいくつかありますが、
これは <em>Knockout.js</em> が使用する付加情報が含まれています。</p>
<p>これらの情報はサーバー側で登録処理を行うのに邪魔になるため、 <code>ko.toJS</code> メソッドを使用して
純粋な <em>JavaScriptのオブジェクト</em> に変換します。</p>
<blockquote>
<ul>
<li><code>ko.toJS</code> - この関数はあなたのビューモデルのオブジェクトグラフに対して、各 observable を現在の値に置換した後で複製するため、Knockout に関連したアーティファクトが存在せず、あなたのデータのみを含んだプレーンなコピーを取得できます。</li>
</ul>
</blockquote>
<p><a href="http://kojs.sukobuto.com/docs/json-data">JSON データの読み込みと保存</a></p>
<p>また、<code>limit</code> が未指定の場合、サーバーサイドで <code>DateTime</code> に変換する際に
エラーとなってしまいます。</p>
<p>空の場合はすごい古い年月をダミー値として登録しておき
表示時にダミー値と一致する場合はブランクに置き換えるようにしました。</p>
<p><br></p>
<p><code>function addItem</code>, <code>function updateItem</code> はもう使用しないので、削除しておきます。</p>
<p><br><br></p>
<h3 id="-3-todo-">(3) リストからTodoを選択すると、詳細を表示する</h3>
<p>できるだけ新しい情報を表示するため、リストを選択すると
非同期にて <em>GET</em> メソッドで <code>/api/Todoes/{id}</code> に問い合わせを行うようにします。</p>
<p>取得したデータを入力フォームに表示します。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * リストからTodoを選択する
 *<span class="hljs-phpdoc"> @param</span> item {ToDoModel} 選択された項目
 */</span>
<span class="hljs-keyword">self</span>.selectTodo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{
    $.ajax({
        url: <span class="hljs-string">"/api/Todoes/"</span> + item.id(),
        dataType: <span class="hljs-string">"json"</span>,
        method: <span class="hljs-string">"GET"</span>
    })
        .done(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
            <span class="hljs-keyword">if</span> (data) {
                <span class="hljs-comment">// yyyy-mm-ddThh:mm:ss という形式で送られてくるので、</span>
                <span class="hljs-comment">// 不要な "T" 以降をカット</span>
                data.limit = data.limit.split(<span class="hljs-string">"T"</span>)[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">if</span> (data.limit == <span class="hljs-string">"1960-01-01"</span>) {
                    <span class="hljs-comment">// ダミーの日付の場合はブランクに置き換える</span>
                    data.limit = <span class="hljs-string">""</span>;
                }
                <span class="hljs-keyword">self</span>.selectedItem(<span class="hljs-keyword">new</span> ToDoModel(data));
            }
        });
};
</code></pre>
<p><br><br></p>
<h3 id="-4-todo-">(4) Todoの削除を行う</h3>
<p>削除ボタンクリックで 非同期にて <em>DELETE</em> メソッドで <code>/api/Todoes/{id}</code> に問い合わせを行うようにします。</p>
<p>削除完了後、リストを再読み込みします。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * 削除ボタンのクリック
 */</span>
<span class="hljs-keyword">self</span>.deleteTodo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    $.ajax({
        url: <span class="hljs-string">"/api/Todoes/"</span> + <span class="hljs-keyword">self</span>.selectedItem().id(),
        dataType: <span class="hljs-string">"json"</span>,
        method: <span class="hljs-string">"DELETE"</span>
    })
        .done(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
            <span class="hljs-comment">// 編集フォームを閉じる</span>
            <span class="hljs-keyword">self</span>.selectedItem(<span class="hljs-keyword">null</span>);

            <span class="hljs-comment">// リストを再読み込み</span>
            <span class="hljs-keyword">self</span>.loadList();

            <span class="hljs-keyword">self</span>.dialog.show({
                title: <span class="hljs-string">'削除完了'</span>,
                message: <span class="hljs-string">'削除が完了しました。'</span>
            });
        });
};
</code></pre>
<p><br><br></p>
<p>デバッグ実行して、以下を確認してください。</p>
<ul>
<li>Todoの表示・追加・変更・削除が行えること</li>
<li>ブラウザを一度閉じ、再度アクセスしても前回登録した内容が表示されること</li>
</ul>
<p><br><br></p>
<hr>
<p><em>ASP.NET Web API</em> と <em>Knockout.js</em> による <em>Single Page Application開発</em> について解説しました。</p>
<p><em>ASP.NET</em> と直接は関係しないために取り上げませんでしたが
実際のアプリケーションには以下の様な機能が必要になってきます。</p>
<ul>
<li>クライアントサイドでの入力チェック</li>
<li>エラーが発生した場合にエラー内容を画面に表示する</li>
<li>サーバーとの通信中に操作できないように画面をロックする</li>
</ul>
<p><br></p>
<p><em>Single Page Application</em> では <em>Ajax</em> による非同期処理を駆使することで
UI/UX の向上が見込まれますが、以下の様な問題点もあります。</p>
<ul>
<li>ブラウザで動く <em>JavaScript</em> がまだまだ貧弱である<ul>
<li>多数のライブラリ間の依存関係を解決する仕組み</li>
<li><em>MVVM</em> などのアーキテクチャにしたがってコーディングしても、クラスやモジュールを読み込む仕組み</li>
</ul>
</li>
<li>新しい <em>JavaScript</em> ライブラリがどんどんリリース / バージョンアップ している<ul>
<li>どれを使えば良いか...？</li>
</ul>
</li>
<li>そもそも <em>JavaScript</em> 自体が進化していっている<ul>
<li><em>ECMAScript5</em> -&gt; <em>ECMAScript2015</em> -&gt; <em>ECMAScript2016</em></li>
</ul>
</li>
</ul>
<p>非常に進化のスピードが早い分野なので、
実際に開発する際には新しい情報を収集するように心がけてください。</p>
<p><br><br></p>
  </div>

  <br>
  <br>

  <div class="container">
    <div class="center-block ad-block">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- aaa-768x90 -->
      <ins class="adsbygoogle"
           style="display:inline-block;width:728px;height:90px"
           data-ad-client="ca-pub-5886049398949171"
           data-ad-slot="8568248344"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="text-muted">ASP.NET勉強会 , &copy; 2015 Kazunori Kimura</p>
    </div>
  </footer>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>
  $(function(){
    $(".contents table").addClass("table");
  });
  </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29149079-3', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
