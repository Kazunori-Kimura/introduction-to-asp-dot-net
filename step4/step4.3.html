<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>introduction to asp dot net - ASP.NET勉強会</title>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <!-- highlightjs -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
  <!-- font-awesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <style>
    /* Sticky footer styles
    -------------------------------------------------- */
    html {
      position: relative;
      min-height: 100%;
    }
    body {
      padding-top: 70px;
      /* Margin bottom by footer height */
      margin-bottom: 70px;
    }
    .footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      /* Set the fixed height of the footer here */
      height: 60px;
      background-color: #f5f5f5;
    }
    /* Custom page CSS
    -------------------------------------------------- */
    /* Not required for template or sticky footer method. */
    .container {
      width: auto;
      max-width: 980px;
      padding: 0 15px;
    }
    .contents p, .contents li {
      font-size: large;
      line-height: 180%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 20px;
      margin-bottom: 15px;
    }
    .container .text-muted {
      margin: 20px 0;
    }
    .ad-block {
      width: auto;
      max-width: 768px;
    }
  </style>
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://kazunori-kimura.github.io/introduction-to-asp-dot-net/">introduction to asp dot net</a>
      </div>
      <p class="navbar-text navbar-right">
        <a href="https://github.com/Kazunori-Kimura/introduction-to-asp-dot-net" class="navbar-link" target="_blank">
          <i class="fa fa-github"></i>
          View on GitHub
        </a>
      </p>
    </div>
  </nav>

  <div class="container contents">
    <!-- contents -->
    <h1 id="todo-">Todoアプリを作成する</h1>
<p>ひとまず、クライアントサイドだけで動作する Todoアプリ を作成します。</p>
<h2 id="home-">Home画面の作成</h2>
<p>まずは HTMLだけを先に作成し、雰囲気を確認します。</p>
<p><em>bootstrap</em> を使用するので、Layoutとスタイルシートを少し修正しておきます。</p>
<p><code>Views/Shared/_LayoutPage1.cshtml</code></p>
<pre><code class="lang-html"><span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">http-equiv</span>=<span class="hljs-value">"X-UA-Compatible"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"IE=edge"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"viewport"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"width=device-width, initial-scale=1"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>@ViewBag.Title<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
    @System.Web.Optimization.Styles.Render("~/bundle/style")
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    @RenderBody()

    @System.Web.Optimization.Scripts.Render("~/bundle/script")
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre>
<ul>
<li>metaタグの追加</li>
<li>不要なdivタグの削除</li>
</ul>
<p><br></p>
<p><code>Content/base.css</code></p>
<pre><code class="lang-css"><span class="hljs-tag">body</span> <span class="hljs-rules">{
  <span class="hljs-rule"><span class="hljs-attribute">margin-top</span>:<span class="hljs-value"> <span class="hljs-number">70px</span></span></span>;
}</span>
</code></pre>
<ul>
<li>上部にナビゲーションバーを配置するので、マージンを設けます。</li>
</ul>
<p><br></p>
<p>つづいて、HTMLをゴリゴリ書いていきます。</p>
<p>ToDoの中身にはとりあえずダミーのデータを設定しておきます。</p>
<p><code>Views/Home/Index.cshtml</code></p>
<pre><code class="lang-html">
@{
    ViewBag.Title = <span class="hljs-string">"Index"</span>;
    Layout = <span class="hljs-string">"~/Views/Shared/_LayoutPage1.cshtml"</span>;
}

&lt;nav <span class="hljs-type">class</span>=<span class="hljs-string">"navbar navbar-inverse navbar-fixed-top"</span>&gt;
    &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"container"</span>&gt;
        &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"navbar-header"</span>&gt;
            &lt;a <span class="hljs-type">class</span>=<span class="hljs-string">"navbar-brand"</span> href=<span class="hljs-string">"#"</span>&gt;KnockoutTodo&lt;/a&gt;
        &lt;/<span class="hljs-keyword">div</span>&gt;
        &lt;button <span class="hljs-type">class</span>=<span class="hljs-string">"btn btn-link navbar-btn navbar-right"</span>&gt;ログアウト&lt;/button&gt;
    &lt;/<span class="hljs-keyword">div</span>&gt;
&lt;/nav&gt;

&lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"container"</span>&gt;
    &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"row"</span>&gt;
        &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"col-md-4"</span>&gt;
            &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"list-group"</span>&gt;
                &lt;a href=<span class="hljs-string">"#"</span> <span class="hljs-type">class</span>=<span class="hljs-string">"list-group-item active"</span>&gt;
                    &lt;h4 <span class="hljs-type">class</span>=<span class="hljs-string">"list-group-item-heading"</span>&gt;
                        <span class="hljs-property">item</span> title
                    &lt;/h4&gt;
                    &lt;p <span class="hljs-type">class</span>=<span class="hljs-string">"list-group-item-text"</span>&gt;<span class="hljs-property">item</span> <span class="hljs-type">text</span>&lt;/p&gt;
                &lt;/a&gt;
                &lt;a href=<span class="hljs-string">"#"</span> <span class="hljs-type">class</span>=<span class="hljs-string">"list-group-item"</span>&gt;
                    &lt;h4 <span class="hljs-type">class</span>=<span class="hljs-string">"list-group-item-heading"</span>&gt;
                        <span class="hljs-property">item</span> title
                    &lt;/h4&gt;
                    &lt;p <span class="hljs-type">class</span>=<span class="hljs-string">"list-group-item-text"</span>&gt;<span class="hljs-property">item</span> <span class="hljs-type">text</span>&lt;/p&gt;
                &lt;/a&gt;
                &lt;a href=<span class="hljs-string">"#"</span> <span class="hljs-type">class</span>=<span class="hljs-string">"list-group-item"</span>&gt;
                    &lt;h4 <span class="hljs-type">class</span>=<span class="hljs-string">"list-group-item-heading"</span>&gt;
                        <span class="hljs-property">item</span> title
                    &lt;/h4&gt;
                    &lt;p <span class="hljs-type">class</span>=<span class="hljs-string">"list-group-item-text"</span>&gt;<span class="hljs-property">item</span> <span class="hljs-type">text</span>&lt;/p&gt;
                &lt;/a&gt;
            &lt;/<span class="hljs-keyword">div</span>&gt;

            &lt;<span class="hljs-keyword">div</span>&gt;
                &lt;button <span class="hljs-type">class</span>=<span class="hljs-string">"btn btn-primary btn-info btn-lg btn-block"</span>&gt;
                    &lt;span <span class="hljs-type">class</span>=<span class="hljs-string">"glyphicon glyphicon-plus"</span>&gt;&lt;/span&gt; 新しいToDoを追加
                &lt;/button&gt;
            &lt;/<span class="hljs-keyword">div</span>&gt;
        &lt;/<span class="hljs-keyword">div</span>&gt;

        &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"col-md-8"</span>&gt;
            &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"panel panel-default"</span>&gt;
                &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"panel-heading"</span>&gt;
                    &lt;h3 <span class="hljs-type">class</span>=<span class="hljs-string">"panel-title"</span>&gt;<span class="hljs-comment">#id&lt;/h3&gt;</span>
                &lt;/<span class="hljs-keyword">div</span>&gt;
                &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"panel-body"</span>&gt;
                    &lt;form <span class="hljs-type">class</span>=<span class="hljs-string">"form-horizontal"</span>&gt;
                        &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"form-group"</span>&gt;
                            &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">"txtSummary"</span> <span class="hljs-type">class</span>=<span class="hljs-string">"col-sm-2 control-label"</span>&gt;概要&lt;/label&gt;
                            &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"col-sm-10"</span>&gt;&lt;input type=<span class="hljs-string">"text"</span> <span class="hljs-type">class</span>=<span class="hljs-string">"form-control"</span> <span class="hljs-property">id</span>=<span class="hljs-string">"txtSummary"</span>&gt;&lt;/<span class="hljs-keyword">div</span>&gt;
                        &lt;/<span class="hljs-keyword">div</span>&gt;
                        &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"form-group"</span>&gt;
                            &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">"txtDetail"</span> <span class="hljs-type">class</span>=<span class="hljs-string">"col-sm-2 control-label"</span>&gt;詳細&lt;/label&gt;
                            &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"col-sm-10"</span>&gt;&lt;textarea <span class="hljs-property">id</span>=<span class="hljs-string">"txtDetail"</span> rows=<span class="hljs-string">"3"</span> <span class="hljs-type">class</span>=<span class="hljs-string">"form-control"</span>&gt;&lt;/textarea&gt;&lt;/<span class="hljs-keyword">div</span>&gt;
                        &lt;/<span class="hljs-keyword">div</span>&gt;
                        &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"form-group"</span>&gt;
                            &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">"txtLimit"</span> <span class="hljs-type">class</span>=<span class="hljs-string">"col-sm-2 control-label"</span>&gt;期限&lt;/label&gt;
                            &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"col-sm-10"</span>&gt;&lt;input type=<span class="hljs-string">"date"</span> <span class="hljs-type">class</span>=<span class="hljs-string">"form-control"</span> <span class="hljs-property">id</span>=<span class="hljs-string">"txtLimit"</span>&gt;&lt;/<span class="hljs-keyword">div</span>&gt;
                        &lt;/<span class="hljs-keyword">div</span>&gt;
                        &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"form-group"</span>&gt;
                            &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"col-sm-offset-2 col-sm-10"</span>&gt;
                                &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"checkbox"</span>&gt;
                                    &lt;label&gt;
                                        &lt;input type=<span class="hljs-string">"checkbox"</span> <span class="hljs-property">id</span>=<span class="hljs-string">"chkDone"</span>&gt; 完了
                                    &lt;/label&gt;
                                &lt;/<span class="hljs-keyword">div</span>&gt;
                            &lt;/<span class="hljs-keyword">div</span>&gt;
                        &lt;/<span class="hljs-keyword">div</span>&gt;
                    &lt;/form&gt;
                &lt;/<span class="hljs-keyword">div</span>&gt;
                &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"panel-footer"</span>&gt;
                    &lt;button <span class="hljs-type">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;
                        &lt;span <span class="hljs-type">class</span>=<span class="hljs-string">"glyphicon glyphicon-floppy-disk"</span>&gt;&lt;/span&gt;
                        登録
                    &lt;/button&gt;
                    &lt;button <span class="hljs-type">class</span>=<span class="hljs-string">"btn btn-danger"</span>&gt;
                        &lt;span <span class="hljs-type">class</span>=<span class="hljs-string">"glyphicon glyphicon-trash"</span>&gt;&lt;/span&gt;
                        削除
                    &lt;/button&gt;
                    &lt;button <span class="hljs-type">class</span>=<span class="hljs-string">"btn btn-default"</span>&gt;
                        キャンセル
                    &lt;/button&gt;
                &lt;/<span class="hljs-keyword">div</span>&gt;
            &lt;/<span class="hljs-keyword">div</span>&gt;
        &lt;/<span class="hljs-keyword">div</span>&gt;
    &lt;/<span class="hljs-keyword">div</span>&gt;
&lt;/<span class="hljs-keyword">div</span>&gt;
</code></pre>
<p>デバッグ実行して画面のイメージを確認します。</p>
<p><br><br></p>
<p>それでは、JavaScriptを実装して動きを付けていきましょう。</p>
<p><br><br></p>
<h2 id="1-todo-">1. ToDoリストを画面に表示する</h2>
<h3 id="todomodel">TodoModel</h3>
<p>まず、モデルを定義します。</p>
<p><code>app.js</code></p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * Todo Model
 * @param 初期値 {object}
 */</span>
<span class="hljs-built_in">var</span> ToDoModel <span class="hljs-subst">=</span> function (<span class="hljs-keyword">params</span>) {
  <span class="hljs-built_in">var</span> <span class="hljs-built_in">self</span> <span class="hljs-subst">=</span> this;

  <span class="hljs-comment">// 引数未指定なら空のobjectを生成</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-subst">!</span><span class="hljs-keyword">params</span>) {
    <span class="hljs-keyword">params</span> <span class="hljs-subst">=</span> {};
  }

  <span class="hljs-comment">// 初期値</span>
  <span class="hljs-built_in">var</span> options <span class="hljs-subst">=</span> {
    id: <span class="hljs-number">0</span>,
    summary: <span class="hljs-string">''</span>,
    detail: <span class="hljs-string">''</span>,
    limit: <span class="hljs-string">''</span>,
    done: <span class="hljs-literal">false</span>
  };

  <span class="hljs-comment">// 初期値を引数で指定された値で上書き</span>
  $<span class="hljs-built_in">.</span>extend(options, <span class="hljs-keyword">params</span>);

  <span class="hljs-comment">// Id (number)</span>
  <span class="hljs-built_in">self</span><span class="hljs-built_in">.</span>id <span class="hljs-subst">=</span> ko<span class="hljs-built_in">.</span>observable(options<span class="hljs-built_in">.</span>id);
  <span class="hljs-comment">// 概要</span>
  <span class="hljs-built_in">self</span><span class="hljs-built_in">.</span>summary <span class="hljs-subst">=</span> ko<span class="hljs-built_in">.</span>observable(options<span class="hljs-built_in">.</span>summary);
  <span class="hljs-comment">// 詳細</span>
  <span class="hljs-built_in">self</span><span class="hljs-built_in">.</span>detail <span class="hljs-subst">=</span> ko<span class="hljs-built_in">.</span>observable(options<span class="hljs-built_in">.</span>detail);
  <span class="hljs-comment">// 期限</span>
  <span class="hljs-built_in">self</span><span class="hljs-built_in">.</span>limit <span class="hljs-subst">=</span> ko<span class="hljs-built_in">.</span>observable(options<span class="hljs-built_in">.</span>limit);
  <span class="hljs-comment">// 完了</span>
  <span class="hljs-built_in">self</span><span class="hljs-built_in">.</span>done <span class="hljs-subst">=</span> ko<span class="hljs-built_in">.</span>observable(options<span class="hljs-built_in">.</span>done);
};
</code></pre>
<p><code>$.extend(obj1, obj2)</code> は jqueryのメソッドで、<code>obj2</code> の内容を <code>obj1</code> にマージします。</p>
<p>ここでは、初期値を引数で指定されたパラメータで上書きします。</p>
<p>その後、各値を <code>observable</code> の変数にセットします。</p>
<p><br><br></p>
<h3 id="viewmodel-">ViewModelの作成</h3>
<pre><code class="lang-js"><span class="hljs-javadoc">/**
 * ViewModel
 */</span>
var AppViewModel = function () {
  var self = <span class="hljs-keyword">this</span>;

  <span class="hljs-comment">// Todoリスト</span>
  self.todoList = ko.observableArray([
    <span class="hljs-keyword">new</span> ToDoModel({ <span class="hljs-string">id:</span> <span class="hljs-number">1</span>, <span class="hljs-string">summary:</span> <span class="hljs-string">'hoge'</span>, <span class="hljs-string">detail:</span> <span class="hljs-string">'foobar1'</span>, <span class="hljs-string">limit:</span> <span class="hljs-string">''</span>, <span class="hljs-string">done:</span><span class="hljs-literal">false</span> }),
    <span class="hljs-keyword">new</span> ToDoModel({ <span class="hljs-string">id:</span> <span class="hljs-number">2</span>, <span class="hljs-string">summary:</span> <span class="hljs-string">'foo'</span>,  <span class="hljs-string">detail:</span> <span class="hljs-string">'foobar2'</span>, <span class="hljs-string">limit:</span> <span class="hljs-string">''</span>, <span class="hljs-string">done:</span><span class="hljs-literal">false</span> }),
    <span class="hljs-keyword">new</span> ToDoModel({ <span class="hljs-string">id:</span> <span class="hljs-number">3</span>, <span class="hljs-string">summary:</span> <span class="hljs-string">'bar'</span>,  <span class="hljs-string">detail:</span> <span class="hljs-string">'foobar3'</span>, <span class="hljs-string">limit:</span> <span class="hljs-string">''</span>, <span class="hljs-string">done:</span><span class="hljs-literal">false</span> })
  ]);
};
</code></pre>
<ul>
<li>observableArray</li>
</ul>
<p><code>observableArray</code> は配列を監視し、要素が追加/削除されると <em>View</em> に反映されます。</p>
<p>ここでは、Todoのリストを <code>observableArray</code> とし、追加・削除されると
画面左側のTodoリストに反映されるように実装していきます。</p>
<p><br><br></p>
<h3 id="-">エントリポイントの作成</h3>
<pre><code class="lang-js"><span class="hljs-comment">// エントリポイント</span>
$(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  ko.applyBindings(<span class="hljs-keyword">new</span> AppViewModel());
});
</code></pre>
<p>HTMLが読み込まれたタイミングで、ViewModel を body に紐付けています。</p>
<p><br></p>
<h3 id="todo-">Todoリストの表示</h3>
<pre><code class="lang-html">&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"col-md-4"</span>&gt;
    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"list-group"</span> data-bind=<span class="hljs-string">"foreach: todoList"</span>&gt;
        &lt;a href=<span class="hljs-string">"#"</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">"list-group-item"</span>&gt;
            &lt;h4 <span class="hljs-keyword">class</span>=<span class="hljs-string">"list-group-item-heading"</span>
                data-bind=<span class="hljs-string">"text: summary"</span>&gt;&lt;/h4&gt;
            &lt;p <span class="hljs-keyword">class</span>=<span class="hljs-string">"list-group-item-text"</span>
               data-bind=<span class="hljs-string">"text: detail"</span>&gt;&lt;/p&gt;
        &lt;/a&gt;
    &lt;/div&gt;
</code></pre>
<ul>
<li><code>foreach</code></li>
</ul>
<p>繰り返し処理の構文です。<br><code>foreach</code>の内側では、カレントのスコープが各アイテムになります。</p>
<p>ここでは、<code>foreach: todoList</code> としているので
<code>AppViewModel</code> の <code>todoList</code> の中身を一つづつ取り出し、処理します。</p>
<p>また、<code>todoList</code> は <code>observableArray</code> なので、要素が追加/削除されるたびに
<code>foreach</code> が呼び出され、<code>todoList</code> の内容がViewに反映されます。</p>
<p><br><br></p>
<h2 id="2-todo-">2. 選択したTodoを編集フォームに表示する</h2>
<p>編集フォームのデータは、登録ボタンをクリックしたタイミングで反映させたいので
入力内容が即時反映されないように、選択されたTodoをコピーし、別のTodoModelのインスタンスに格納します。</p>
<p>登録時は、別のインスタンスから該当のインスタンスに値を戻します。</p>
<p>ViewModelにプロパティとメソッドを追加します。</p>
<pre><code class="lang-js"><span class="hljs-comment">// 選択されたTodoを格納</span>
<span class="hljs-keyword">self</span>.selectedItem = ko.observable();

<span class="hljs-comment">/**
 * リストからTodoを選択する
 *<span class="hljs-phpdoc"> @param</span> item {ToDoModel} 選択された項目
 */</span>
<span class="hljs-keyword">self</span>.selectTodo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(item)</span> </span>{
  <span class="hljs-keyword">self</span>.selectedItem(<span class="hljs-keyword">new</span> ToDoModel({
    id: item.id(),
    summary: item.summary(),
    detail: item.detail(),
    limit: item.limit(),
    done: item.done()
  }));
};
</code></pre>
<p><br></p>
<h3 id="-">リストのアイテムとメソッドを紐付ける</h3>
<pre><code class="lang-html">&lt;div <span class="hljs-variable">class=</span><span class="hljs-string">"list-group"</span> <span class="hljs-variable">data-bind=</span><span class="hljs-string">"foreach: todoList"</span>&gt;
    &lt;a <span class="hljs-variable">href=</span><span class="hljs-string">"#"</span> <span class="hljs-variable">class=</span><span class="hljs-string">"list-group-item"</span>
       <span class="hljs-variable">data-bind=</span><span class="hljs-string">"click: $root.selectTodo"</span>&gt;
        &lt;h4 <span class="hljs-variable">class=</span><span class="hljs-string">"list-group-item-heading"</span>
            <span class="hljs-variable">data-bind=</span><span class="hljs-string">"text: summary"</span>&gt;&lt;/h4&gt;
        &lt;p <span class="hljs-variable">class=</span><span class="hljs-string">"list-group-item-text"</span>
           <span class="hljs-variable">data-bind=</span><span class="hljs-string">"text: detail"</span>&gt;&lt;/p&gt;
    &lt;/a&gt;
&lt;/div&gt;
</code></pre>
<p>aタグに <code>data-bind=&quot;click: $root.selectedItem&quot;</code> と追記します。</p>
<p><code>$root</code> は body にバインドした AppViewModel を表します。</p>
<p><code>foreach</code> の中では、h4タグやpタグでのデータバインドのように、
デフォルトでは配列要素のプロパティが選択されます。</p>
<p>aタグをクリックしたときには、配列要素では無く、
AppViewModel に定義したメソッドを呼び出したいのでこのような記述になります。</p>
<p><code>click</code> で指定したメソッドの引数には <em>バインディング・コンテキスト</em> が渡されます。</p>
<blockquote>
<p><a href="http://kojs.sukobuto.com/docs/binding-context">バインディング・コンテキスト</a><br>バインディング・コンテキストは、バインディングから参照できるデータをもつオブジェクトです。 バインディングの適用にあたって、Knockout は自動的にバインディング・コンテキストの階層を作成・管理します。 階層のルートは、ko.applyBindings(viewModel) に渡した viewModel です。 また、with や foreach などのフロー制御バインディングを使う度に、 ネストされた ViewModel データを参照する子コンテキストが作成されます。</p>
</blockquote>
<p>今回は <code>foreach</code> 内で <code>click</code> を定義したので、メソッドの引数には配列の各要素が渡されます。</p>
<p><br></p>
<h3 id="-selecteditem-">編集フォームと selectedItem を紐付ける</h3>
<pre><code class="lang-html">&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"panel panel-default"</span> data-bind=<span class="hljs-string">"visible: selectedItem, with: selectedItem"</span>&gt;
    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"panel-heading"</span>&gt;
        &lt;h3 <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"panel-title"</span>&gt;#&lt;span data-bind=<span class="hljs-string">"text: id"</span>&gt;&lt;/span&gt;&lt;/h3&gt;
    &lt;/div&gt;
    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"panel-body"</span>&gt;
        &lt;form <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-horizontal"</span>&gt;
            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-group"</span>&gt;
                &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">"txtSummary"</span> <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-sm-2 control-label"</span>&gt;概要&lt;/label&gt;
                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-sm-10"</span>&gt;
                    &lt;input <span class="hljs-class"><span class="hljs-keyword">type</span>=</span><span class="hljs-string">"text"</span> <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-control"</span>
                           id=<span class="hljs-string">"txtSummary"</span>
                           data-bind=<span class="hljs-string">"value: summary"</span>&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-group"</span>&gt;
                &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">"txtDetail"</span> <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-sm-2 control-label"</span>&gt;詳細&lt;/label&gt;
                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-sm-10"</span>&gt;
                    &lt;textarea id=<span class="hljs-string">"txtDetail"</span> rows=<span class="hljs-string">"3"</span> <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-control"</span>
                              data-bind=<span class="hljs-string">"value: detail"</span>&gt;&lt;/textarea&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-group"</span>&gt;
                &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">"txtLimit"</span> <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-sm-2 control-label"</span>&gt;期限&lt;/label&gt;
                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-sm-10"</span>&gt;
                    &lt;input <span class="hljs-class"><span class="hljs-keyword">type</span>=</span><span class="hljs-string">"date"</span> <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-control"</span>
                           id=<span class="hljs-string">"txtLimit"</span>
                           data-bind=<span class="hljs-string">"value: limit"</span>&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"form-group"</span>&gt;
                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"col-sm-offset-2 col-sm-10"</span>&gt;
                    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"checkbox"</span>&gt;
                        &lt;label&gt;
                            &lt;input <span class="hljs-class"><span class="hljs-keyword">type</span>=</span><span class="hljs-string">"checkbox"</span> id=<span class="hljs-string">"chkDone"</span>
                                   data-bind=<span class="hljs-string">"checked: done"</span>&gt; 完了
                        &lt;/label&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/form&gt;
    &lt;/div&gt;
    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"panel-footer"</span>&gt;
        &lt;button <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"btn btn-primary"</span>&gt;
            &lt;span <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"glyphicon glyphicon-floppy-disk"</span>&gt;&lt;/span&gt;
            登録
        &lt;/button&gt;
        &lt;button <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"btn btn-danger"</span>&gt;
            &lt;span <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"glyphicon glyphicon-trash"</span>&gt;&lt;/span&gt;
            削除
        &lt;/button&gt;
        &lt;button <span class="hljs-class"><span class="hljs-keyword">class</span>=</span><span class="hljs-string">"btn btn-default"</span>&gt;
            キャンセル
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<ul>
<li>visible</li>
</ul>
<p>指定された要素が <code>true</code> と判定されるような場合、該当要素が表示されます。<br>逆に、指定された要素が <code>false</code> と判定されるような場合(<code>boolean</code>の<code>false</code>、<code>string</code>の<code>&quot;&quot;</code>、<code>number</code>の<code>0</code>、<code>null</code>、<code>undefined</code>)、該当要素は非表示となります。</p>
<p><br></p>
<ul>
<li>with</li>
</ul>
<p>with バインディングは新たな バインディング・コンテキスト を作成します。</p>
<p>ここでは、編集フォーム内の バインディング・コンテキスト を <code>selectedItem</code> に変更しています。</p>
<p><br></p>
<ul>
<li>value</li>
</ul>
<p>関連付けられた DOM エレメントの値と ViewModel のプロパティーをリンクさせます。
<code>&lt;input&gt;</code> や <code>&lt;select&gt;</code>, <code>&lt;textarea&gt;</code> などのフォーム部品で使用します。</p>
<ul>
<li>checked</li>
</ul>
<p>ViewModel のプロパティとチェックボックス や ラジオボタン などのチェックできるフォーム部品をリンクします。</p>
<p><br><br></p>
<h2 id="3-">3. 選択中の項目を強調する</h2>
<p>現在編集しているTodoがどれなのか分かりやすいように、選択されている要素の背景色を青にします。</p>
<p>bootstrap の active クラスを設定するだけで、青地に白文字で表示されるようになりますので
knockout では 選択要素の aタグに activeクラスをセットするように実装します。</p>
<p><br><br></p>
<h3 id="-">要素が選択されているかどうかを判定するメソッドの追加</h3>
<p>ViewModel に、その要素が選択されている要素かどうかを判定するメソッドを追加します。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * リストの項目が選択されたTodoかどうか
 *<span class="hljs-phpdoc"> @param</span> target {TodoModel}
 *<span class="hljs-phpdoc"> @return</span> {boolean}
 */</span>
<span class="hljs-keyword">self</span>.isActive = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(target)</span> </span>{
  <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">self</span>.selectedItem();
  <span class="hljs-keyword">if</span> (item) {
    <span class="hljs-keyword">return</span> target.id() == item.id();
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
};
</code></pre>
<p><br></p>
<h3 id="-view-">判定メソッドをViewに紐付ける</h3>
<p>aタグを以下のように修正します。</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"#"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"list-group-item"</span>
  <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"click: $root.selectTodo, css: { active: $root.isActive($data) }"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">h4</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"list-group-item-heading"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"text: summary"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">h4</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">p</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"list-group-item-text"</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"text: detail"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
</code></pre>
<ul>
<li>css バインディング</li>
</ul>
<p><code>css: { active: $root.isActive($data) }</code> とした場合、 <code>$root.isActive($data)</code> が
<code>true</code> となった場合のみ、DOM要素に <code>active</code> クラスをセットします。</p>
<p><br></p>
<ul>
<li>$data</li>
</ul>
<p><code>foreach</code> でループしている時の「現在のアイテム」になります。</p>
<p><code>$data</code> に別名を付けることもできます。</p>
<p><code>foreach: { data: items, as: &#39;item&#39; }</code> とすると、<code>$data</code> の代わりに <code>item</code> で
各要素を参照できます。</p>
<p><code>foreach</code> をネストする場合は別名を付けたほうが分かりやすいでしょう。</p>
<p><br><br></p>
<h2 id="4-">4. 追加ボタンクリック時の処理</h2>
<p>編集フォームに空のTodoをセットします。</p>
<p>ViewModelに以下のメソッドを追加します。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * 新しいTodoの入力フォームを表示する
 */</span>
<span class="hljs-keyword">self</span>.addTodo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">self</span>.selectedItem(<span class="hljs-keyword">new</span> ToDoModel());
};
</code></pre>
<p><br></p>
<p>追加ボタンにメソッドを紐付けます。</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-primary btn-info btn-lg btn-block"</span>
  <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"click: $root.addTodo"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"glyphicon glyphicon-plus"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span> 新しいToDoを追加
<span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
</code></pre>
<p><br></p>
<p>追加時には削除ボタンが使用できないように非表示とします。</p>
<p>selectedItem の id が 0 の場合は追加、<br>selectedItem の id が 0 以外の場合は更新と判断します。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * 削除が可能かどうか
 *<span class="hljs-phpdoc"> @return</span> {boolean}
 */</span>
<span class="hljs-keyword">self</span>.isDeletable = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.selectedItem().id() != <span class="hljs-number">0</span>;
};
</code></pre>
<p><br></p>
<p>非表示となるように、 visibleバインディングを設定します。</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-danger"</span>
  <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"visible:$root.isDeletable()"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"glyphicon glyphicon-trash"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
  削除
<span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
</code></pre>
<p><br><br></p>
<h2 id="5-">5. キャンセルボタンクリック時の処理</h2>
<p>キャンセルをクリックした時は selectedItem に <code>null</code> をセットします。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * キャンセルボタンのクリック
 */</span>
<span class="hljs-keyword">self</span>.cancelEdit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// 編集フォームを閉じる</span>
  <span class="hljs-keyword">self</span>.selectedItem(<span class="hljs-keyword">null</span>);
};
</code></pre>
<p><br></p>
<p>キャンセルボタンにメソッドを紐付けます。</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-default"</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"click: $root.cancelEdit"</span>&gt;</span>
  キャンセル
<span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
</code></pre>
<p><br><br></p>
<h2 id="6-">6. 登録ボタンクリック時の処理</h2>
<p>selectedItem の id が 0 の場合は追加、
selectedItem の id が 0 以外の場合は更新なので、<br>id の値に応じて処理を呼び分けます。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * 登録ボタンのクリック
 */</span>
<span class="hljs-keyword">self</span>.registTodo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">self</span>.selectedItem();
  <span class="hljs-keyword">if</span> (item.id() == <span class="hljs-number">0</span>) {
    addItem(item);
  } <span class="hljs-keyword">else</span> {
    updateItem(item);
  }

  <span class="hljs-comment">// 編集フォームを閉じる</span>
  <span class="hljs-keyword">self</span>.selectedItem(<span class="hljs-keyword">null</span>);
};

<span class="hljs-comment">/**
 * Todoを登録する
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addItem</span> <span class="hljs-params">(todoItem)</span> </span>{
  <span class="hljs-comment">// リストに登録されている末尾の要素のIDを+1する</span>
  <span class="hljs-keyword">var</span> len = <span class="hljs-keyword">self</span>.todoList().length;
  <span class="hljs-keyword">var</span> newId = <span class="hljs-keyword">self</span>.todoList()[len - <span class="hljs-number">1</span>].id() + <span class="hljs-number">1</span>;
  <span class="hljs-comment">// idを設定</span>
  todoItem.id(newId);
  <span class="hljs-comment">// リストに追加</span>
  <span class="hljs-keyword">self</span>.todoList.push(todoItem);
}

<span class="hljs-comment">/**
 * Todoを更新する
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateItem</span> <span class="hljs-params">(todoItem)</span> </span>{
  <span class="hljs-keyword">var</span> len = <span class="hljs-keyword">self</span>.todoList().length;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;len; i++) {
    <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">self</span>.todoList()[i];
    <span class="hljs-keyword">if</span> (todoItem.id() == item.id()) {
      <span class="hljs-comment">// Todoを更新</span>
      item.summary(todoItem.summary());
      item.detail(todoItem.detail());
      item.limit(todoItem.limit());
      item.done(todoItem.done());

      <span class="hljs-keyword">break</span>;
    }
  }
}
</code></pre>
<p>observableArray は通常の配列のように <code>length</code> で要素数を取得したり
<code>push</code> で要素を追加できます。</p>
<p><br></p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-primary"</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"click: $root.registTodo"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"glyphicon glyphicon-floppy-disk"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
  登録
<span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
</code></pre>
<p>登録ボタンをクリックしたらメソッドを呼び出すように、clickバインディングで紐付けます。</p>
<p><br></p>
<h3 id="-javascript-public-private">補足: JavaScriptで擬似的な public / private</h3>
<p><code>self.</code> から始まるプロパティ、メソッドは <em>public</em> だと考えてください。</p>
<p><code>var</code> や <code>function</code> から始まるプロパティ、メソッドは <em>private</em> です。
ViewModelの外から参照することはできません。</p>
<p>これも JavaScript でよく使用されるテクニックのひとつです。</p>
<p><br><br></p>
<h2 id="7-">7. 削除ボタンクリック時の処理</h2>
<p>observableArray の <code>remove</code> メソッドで、現在選択されている要素を削除します。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * 削除ボタンのクリック
 */</span>
<span class="hljs-keyword">self</span>.deleteTodo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">self</span>.todoList.remove(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> </span>{
    <span class="hljs-keyword">return</span> item.id() == <span class="hljs-keyword">self</span>.selectedItem().id();
  });

  <span class="hljs-comment">// 編集フォームを閉じる</span>
  <span class="hljs-keyword">self</span>.selectedItem(<span class="hljs-keyword">null</span>);
};
</code></pre>
<p><code>todoList</code> の各要素に対して <code>remove</code> メソッドで指定された <code>function</code> が実行され、
<code>true</code> となった要素が削除されます。</p>
<p><br></p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-danger"</span>
  <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"visible:$root.isDeletable(), click: $root.deleteTodo"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"glyphicon glyphicon-trash"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
  削除
<span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
</code></pre>
<p>clickバインディングで紐付けます。</p>
<p><br><br></p>
<hr>
<h2 id="-">おまけ: モーダルダイアログの表示</h2>
<p>登録、削除が完了したらモーダルダイアログでメッセージを表示するように実装します。</p>
<p>bootstrap の modalダイアログを利用します。</p>
<pre><code class="lang-html">&lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"modal fade"</span> <span class="hljs-property">id</span>=<span class="hljs-string">"dialog"</span> data-bind=<span class="hljs-string">"with: dialog"</span>&gt;
  &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"modal-dialog"</span>&gt;
    &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"modal-content"</span>&gt;
      &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"modal-header"</span>&gt;
        &lt;h4 <span class="hljs-type">class</span>=<span class="hljs-string">"modal-title"</span> data-bind=<span class="hljs-string">"text: title"</span>&gt;&lt;/h4&gt;
      &lt;/<span class="hljs-keyword">div</span>&gt;
      &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"modal-body"</span>&gt;
        &lt;p <span class="hljs-type">class</span>=<span class="hljs-string">"lead"</span> data-bind=<span class="hljs-string">"text: message"</span>&gt;&lt;/p&gt;
      &lt;/<span class="hljs-keyword">div</span>&gt;
      &lt;<span class="hljs-keyword">div</span> <span class="hljs-type">class</span>=<span class="hljs-string">"modal-footer"</span>&gt;
        &lt;button <span class="hljs-type">class</span>=<span class="hljs-string">"btn btn-primary"</span> data-dismiss=<span class="hljs-string">"modal"</span>&gt;OK&lt;/button&gt;
      &lt;/<span class="hljs-keyword">div</span>&gt;
    &lt;/<span class="hljs-keyword">div</span>&gt;
  &lt;/<span class="hljs-keyword">div</span>&gt;
&lt;/<span class="hljs-keyword">div</span>&gt;
</code></pre>
<p>DialogModel を定義します。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * modal dialog model
 */</span>
<span class="hljs-keyword">var</span> DialogModel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;

  <span class="hljs-keyword">self</span>.id = <span class="hljs-string">'#dialog'</span>;
  <span class="hljs-keyword">self</span>.title = ko.observable(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">self</span>.message = ko.observable(<span class="hljs-string">''</span>);

  <span class="hljs-comment">/**
   * ダイアログの表示
   *<span class="hljs-phpdoc"> @param</span> {object}
   */</span>
  <span class="hljs-keyword">self</span>.show = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(opts)</span> </span>{
    <span class="hljs-comment">// 初期値</span>
    <span class="hljs-keyword">var</span> def = {
      title: <span class="hljs-string">''</span>,
      message: <span class="hljs-string">''</span>
    };
    $.extend(def, opts);

    <span class="hljs-keyword">self</span>.title(def.title);
    <span class="hljs-keyword">self</span>.message(def.message);

    <span class="hljs-comment">// モーダルダイアログの表示</span>
    $(<span class="hljs-keyword">self</span>.id).modal(<span class="hljs-string">'show'</span>);
  };
  <span class="hljs-comment">/**
   * ダイアログの非表示
   */</span>
  <span class="hljs-keyword">self</span>.hide = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    $(<span class="hljs-keyword">self</span>.id).modal(<span class="hljs-string">'hide'</span>);
  };
};
</code></pre>
<p>AppViewModel で DialogModel を生成します。</p>
<pre><code class="lang-js"><span class="hljs-keyword">var</span> AppViewModel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;

  <span class="hljs-comment">// Todoリスト</span>
  <span class="hljs-keyword">self</span>.todoList = ko.observableArray([ ... ]);

  <span class="hljs-comment">// 選択されたTodo</span>
  <span class="hljs-keyword">self</span>.selectedItem = ko.observable();

  <span class="hljs-comment">// モーダルダイアログ</span>
  <span class="hljs-keyword">self</span>.dialog = <span class="hljs-keyword">new</span> DialogModel();
</code></pre>
<p>登録、削除後にモーダルダイアログを表示するよう
処理を修正します。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * 登録ボタンのクリック
 */</span>
<span class="hljs-keyword">self</span>.registTodo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">self</span>.selectedItem();
  <span class="hljs-keyword">if</span> (item.id() == <span class="hljs-number">0</span>) {
    addItem(item);
  } <span class="hljs-keyword">else</span> {
    updateItem(item);
  }

  <span class="hljs-comment">// 編集フォームを閉じる</span>
  <span class="hljs-keyword">self</span>.selectedItem(<span class="hljs-keyword">null</span>);

  <span class="hljs-keyword">self</span>.dialog.show({
    title: <span class="hljs-string">'登録完了'</span>,
    message: <span class="hljs-string">'登録が完了しました。'</span>
  });
};

<span class="hljs-comment">/**
 * 削除ボタンのクリック
 */</span>
<span class="hljs-keyword">self</span>.deleteTodo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">self</span>.todoList.remove(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> </span>{
    <span class="hljs-keyword">return</span> item.id() == <span class="hljs-keyword">self</span>.selectedItem().id();
  });

  <span class="hljs-comment">// 編集フォームを閉じる</span>
  <span class="hljs-keyword">self</span>.selectedItem(<span class="hljs-keyword">null</span>);

  <span class="hljs-keyword">self</span>.dialog.show({
    title: <span class="hljs-string">'削除完了'</span>,
    message: <span class="hljs-string">'削除が完了しました。'</span>
  });
};
</code></pre>
<p><br><br></p>
<hr>
<p>以上で、クライアントサイドだけで動作する Todoアプリが完成しました。</p>
<p>当然、データを保存する機能がないため、ブラウザをリロードすると更新した内容が失われます。</p>
<p>次回は Ajax で Web API を呼び出すことで クライアントサイドとサーバーサイドの処理を連携させ、
Todoアプリを完成させます。</p>
<p><br><br></p>
  </div>

  <br>
  <br>

  <div class="container">
    <div class="center-block ad-block">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- aaa-768x90 -->
      <ins class="adsbygoogle"
           style="display:inline-block;width:728px;height:90px"
           data-ad-client="ca-pub-5886049398949171"
           data-ad-slot="8568248344"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="text-muted">ASP.NET勉強会 , &copy; 2015 Kazunori Kimura</p>
    </div>
  </footer>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>
  $(function(){
    $(".contents table").addClass("table");
  });
  </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29149079-3', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
