<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>introduction to asp dot net - ASP.NET勉強会</title>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <!-- highlightjs -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
  <!-- font-awesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <style>
    /* Sticky footer styles
    -------------------------------------------------- */
    html {
      position: relative;
      min-height: 100%;
    }
    body {
      padding-top: 70px;
      /* Margin bottom by footer height */
      margin-bottom: 70px;
    }
    .footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      /* Set the fixed height of the footer here */
      height: 60px;
      background-color: #f5f5f5;
    }
    /* Custom page CSS
    -------------------------------------------------- */
    /* Not required for template or sticky footer method. */
    .container {
      width: auto;
      max-width: 980px;
      padding: 0 15px;
    }
    .contents p, .contents li {
      font-size: large;
      line-height: 180%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 20px;
      margin-bottom: 15px;
    }
    .container .text-muted {
      margin: 20px 0;
    }
    .ad-block {
      width: auto;
      max-width: 768px;
    }
  </style>
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://kazunori-kimura.github.io/introduction-to-asp-dot-net/">introduction to asp dot net</a>
      </div>
      <p class="navbar-text navbar-right">
        <a href="https://github.com/Kazunori-Kimura/introduction-to-asp-dot-net" class="navbar-link" target="_blank">
          <i class="fa fa-github"></i>
          View on GitHub
        </a>
      </p>
    </div>
  </nav>

  <div class="container contents">
    <!-- contents -->
    <h1 id="-knockout-js-">簡単な Knockout.js の例</h1>
<h2 id="hello-world-">Hello, World!</h2>
<p>非常に簡単な <code>knockout.js</code> のアプリの作成を通して、<code>MVVM</code> の概要について解説します。</p>
<p><br><br></p>
<h3 id="view-">View の作成</h3>
<p>まず、<em>MVVM</em> の <em>V</em> にあたる、<em>View</em> を作成します。</p>
<p><code>index.cshtml</code> を以下のように修正します。</p>
<pre><code class="lang-html"><span class="xml">
@</span><span class="hljs-expression">{
    <span class="hljs-variable">ViewBag.Title</span> = <span class="hljs-string">"Index"</span>;
    <span class="hljs-variable">Layout</span> = <span class="hljs-string">"~/Views/Shared/_LayoutPage1.cshtml"</span>;
}</span><span class="xml">

<span class="hljs-tag">&lt;<span class="hljs-title">h2</span>&gt;</span>Index<span class="hljs-tag">&lt;/<span class="hljs-title">h2</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span>
       <span class="hljs-attribute">placeholder</span>=<span class="hljs-value">"お名前"</span>
       <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"value: user.name, valueUpdate: 'afterkeydown'"</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>こんにちは、<span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"text: user.name"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>さん！<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span></span>
</code></pre>
<p><br><br></p>
<p>HTMLの要素と <code>knockout.js</code> の処理を紐付けるには、<code>data-bind</code> という属性を使用します。</p>
<p><br></p>
<pre><code class="lang-js"><span class="hljs-type">data</span>-<span class="hljs-keyword">bind</span>=<span class="hljs-string">"value: user.name, valueUpdate: 'afterkeydown'"</span>
</code></pre>
<p><br></p>
<p>これは、以下のような意味になります。</p>
<ul>
<li><code>value</code> に <code>user.name</code> をセットする</li>
<li>&#39;afterkeydown&#39; (キーの押下時) に更新する<ul>
<li><code>valueUpdate: &#39;afterkeydown&#39;</code> を指定しない場合、テキストボックスからフォーカスが外れた場合に更新されます。</li>
</ul>
</li>
</ul>
<p><br></p>
<p>少しスタイルシートを修正します。</p>
<p><code>base.css</code></p>
<pre><code class="lang-css"><span class="hljs-tag">body</span> <span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">margin</span>:<span class="hljs-value"> <span class="hljs-number">40px</span></span></span>;
}</span>
</code></pre>
<p><br><br></p>
<h3 id="model-">Modelの定義</h3>
<p><em>MVVM</em> の <em>M</em> にあたる、<em>Model</em> を作成します。</p>
<p><code>app.js</code></p>
<pre><code class="lang-js"><span class="hljs-comment">// app.js</span>
<span class="hljs-comment">/**
 * User Model
 */</span>
<span class="hljs-keyword">var</span> UserModel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">UserModel</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;
    <span class="hljs-keyword">self</span>.name = ko.observable(<span class="hljs-string">"名無し"</span>);
};
</code></pre>
<ul>
<li><code>ko</code> は <code>knockout.js</code>のオブジェクトです。</li>
<li><code>observable</code> は該当の変数を<code>knockout.js</code>の監視対象とします。<ul>
<li>ここでは、<code>UserModel</code>の<code>name</code>の値が変わるたびに <em>View</em> に反映されます。</li>
</ul>
</li>
</ul>
<p><br></p>
<hr>
<p>ちなみに...</p>
<p><br></p>
<pre><code class="lang-js"><span class="hljs-keyword">var</span> varName = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">funcName</span><span class="hljs-params">()</span></span>{ };
</code></pre>
<p>というのは <code>JavaScript</code>で<code>class</code> (のようなもの) を定義する際の構文です。</p>
<p>また、<code>var self = this;</code> というのは、<code>JavaScript</code>でよく使用するテクニックです。</p>
<p>JavaScript では文脈によって <code>this</code> の中身が異なります (例えば、button押下時のイベントから呼び出された場合、
<code>this</code> には button のオブジェクトが入っています) が
<code>class</code>内部ではどのような状況であっても自分自身を取得する方法が欲しいので、
<code>new</code> した際に <code>this</code> を <code>self</code> という変数に格納しています。</p>
<p><code>self</code>変数を参照することで、どのような文脈からの呼び出しであっても <code>self</code> は自分自身を指します。</p>
<p><br></p>
<hr>
<p><br><br></p>
<h3 id="viewmodel-">ViewModel の定義</h3>
<p>つづいて、 <em>MVVM</em> の <em>VM</em> にあたる、<em>ViewModel</em> を作成します。</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * ApplicationViewModel
 */</span>
<span class="hljs-keyword">var</span> AppViewModel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AppViewModel</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;
    <span class="hljs-keyword">self</span>.user = <span class="hljs-keyword">new</span> UserModel();
};
</code></pre>
<ul>
<li><code>AppViewModel</code> は 変数 <code>user</code> に <em>Model</em> <code>UserModel</code> のインスタンスを一つ保持しています。</li>
</ul>
<p><br><br></p>
<h3 id="view-viewmodel-">View と ViewModel を紐付ける</h3>
<p>最後に、<em>View</em> と <em>ViewModel</em> を紐付けます。</p>
<pre><code class="lang-js">$(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    ko.applyBindings(<span class="hljs-keyword">new</span> AppViewModel());
});
</code></pre>
<p><br></p>
<ul>
<li><code>ko.applyBindings(viewModel);</code> で <code>body</code>と<code>ViewModel</code>を紐付けます。<ul>
<li>HTML内の各要素に<code>data-bind</code>属性を設定することで、<em>ViewModel</em> と <em>View</em> の紐付けの詳細を定義します。</li>
</ul>
</li>
</ul>
<p><br></p>
<p>デバッグ実行して動作確認してください。</p>
<p>テキストボックスの値を変更すると、ほぼリアルタイムで <code>span</code>タグ内のテキストに反映されます。</p>
<p><br></p>
<hr>
<p><br></p>
<h3 id="-viewmodel-">補足: ViewModelについて</h3>
<p>今回の例は <em>ViewModel</em> がひとつですが、メニュー部分とコンテンツ部分で <em>ViewModel</em> を分割するような場合、
以下のように記述することが可能です。</p>
<pre><code class="lang-js"><span class="hljs-comment">// メニュー部分</span>
ko.applyBindings(<span class="hljs-keyword">new</span> MenuViewModel(), <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"menu"</span>));
<span class="hljs-comment">// コンテンツ部分</span>
ko.applyBindings(<span class="hljs-keyword">new</span> ContentViewModel(), <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"content"</span>));
</code></pre>
<p><br></p>
<h3 id="-">補足: バインディングについて</h3>
<p><code>data-bind=&quot;value: name&quot;</code> といった、DOM要素 と ViewModel のプロパティ・メソッドを紐付ける機能を
<em>バインディング</em> と呼びます。</p>
<p>knockout.js では 様々なバインディングの機能が用意されています。<br>また、<em>カスタムバインディング</em> を作成して、独自のバインディングを実装することも可能です。</p>
<p><em>バインディング</em> の詳細については knockout.js のドキュメントを参照してください。</p>
<p><br></p>
<hr>
<p><br></p>
<p><a href="step4.3.html">次へ</a></p>
<p><br><br></p>
  </div>

  <br>
  <br>

  <div class="container">
    <div class="center-block ad-block">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- aaa-768x90 -->
      <ins class="adsbygoogle"
           style="display:inline-block;width:728px;height:90px"
           data-ad-client="ca-pub-5886049398949171"
           data-ad-slot="8568248344"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="text-muted">ASP.NET勉強会 , &copy; 2015 Kazunori Kimura</p>
    </div>
  </footer>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>
  $(function(){
    $(".contents table").addClass("table");
  });
  </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29149079-3', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
