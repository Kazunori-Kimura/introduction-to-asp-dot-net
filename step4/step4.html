<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>introduction to asp dot net - ASP.NET勉強会</title>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <!-- highlightjs -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
  <!-- font-awesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <style>
    /* Sticky footer styles
    -------------------------------------------------- */
    html {
      position: relative;
      min-height: 100%;
    }
    body {
      padding-top: 70px;
      /* Margin bottom by footer height */
      margin-bottom: 70px;
    }
    .footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      /* Set the fixed height of the footer here */
      height: 60px;
      background-color: #f5f5f5;
    }
    /* Custom page CSS
    -------------------------------------------------- */
    /* Not required for template or sticky footer method. */
    .container {
      width: auto;
      max-width: 980px;
      padding: 0 15px;
    }
    .contents p, .contents li {
      font-size: large;
      line-height: 180%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 20px;
    }
    .container .text-muted {
      margin: 20px 0;
    }
  </style>
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://kazunori-kimura.github.io/introduction-to-asp-dot-net/">introduction to asp dot net</a>
      </div>
      <p class="navbar-text navbar-right">
        <a href="https://github.com/Kazunori-Kimura/introduction-to-asp-dot-net" class="navbar-link" target="_blank">
          <i class="fa fa-github"></i>
          View on GitHub
        </a>
      </p>
    </div>
  </nav>

  <div class="container contents">
    <!-- contents -->
    <h1 id="-asp-net-web-api-knockout-js-single-page-application-"><code>ASP.NET Web API</code>と<code>knockout.js</code>によるSingle Page Application開発</h1>
<h2 id="single-page-application-">Single Page Application とは？</h2>
<ul>
<li>文字通り、<em>単一ページによるWebアプリケーション</em> です。</li>
<li>サーバーとのやりとりは <code>REST</code> などを使用して行います。</li>
</ul>
<p><br></p>
<h3 id="ui-">UIの作成</h3>
<ul>
<li>Webアプリケーションなので、ユーザー インターフェースは <code>HTML</code> です。</li>
<li>単一ページなので、画面遷移は行われません。<ul>
<li>サーバーから受信したデータを表示するためには、HTMLの要素
(<em>D</em> ocument <em>O</em> bject <em>M</em> odel, <code>DOM</code>) を JavaScript で頻繁に書き換える必要があります。</li>
<li>全ての処理を自分でコーディングすることも可能ですが、通常はJavaScriptフレームワークを使用します。</li>
</ul>
</li>
</ul>
<p><br></p>
<h4 id="-javascript-">代表的な JavaScriptフレームワーク</h4>
<ul>
<li><a href="http://backbonejs.org/">backbone.js</a> : JavaScriptフレームワークの草分け的存在。</li>
<li><a href="https://angularjs.org/">AngularJS</a> : Googleが中心になって開発している。利用者も多い。</li>
<li><a href="http://www.sencha.com/">Sencha</a> : <code>ExtJS</code>という名前で、かなり昔からあったライブラリ。きれいなUIが特徴。</li>
<li><a href="http://knockoutjs.com/">knockout.js</a> : Microsoftが中心になって開発している。IE6でも動作する。</li>
</ul>
<p>上記以外にも大小様々なフレームワークが存在します。</p>
<p>それぞれ守備範囲が異なるので、プロジェクトにあったものを選択する (あるいは、採用したJavaScriptフレームワークの機能を考慮して設計する) 必要があります。</p>
<p><br></p>
<p>今回は比較的軽量な <code>knockout.js</code> を使用します。</p>
<ul>
<li>Ajax通信機能は含まれていないため、 <code>jQuery</code> と合わせて使用します。<ul>
<li>HTMLへのデータ反映は <code>knockout.js</code> に任せ、<code>jQuery</code> では表示部分を触らないよう考慮して設計します。<br><code>knockout.js</code> と <code>jQuery</code> のHTML操作が混在するとカオスになります。</li>
</ul>
</li>
<li>UIのレイアウトには <code>Bootstrap</code>を使用します。<ul>
<li>こちらも表示/非表示の切り替え等は<code>knockout.js</code>で行います。</li>
</ul>
</li>
</ul>
<p><br>
<br></p>
<hr>
<h2 id="knockout-js">Knockout.js</h2>
<h3 id="knockout-js-mvvm">knockout.js の MVVM</h3>
<p><code>knockout.js</code>では、以下の様な構成でコーディングします。</p>
<ul>
<li><em>M</em> odel : サーバーから受け取ったデータ</li>
<li><em>V</em> iew : HTML</li>
<li><em>V</em> iew<em>M</em>odel : Modelを保持し、Viewとの仲介を行います。</li>
</ul>
<p><code>MVVM</code> は <code>クライアントサイドMVC</code> と呼ばれる事もあります。</p>
<h3 id="hello-world-">Hello, World!</h3>
<p>まず、非常に簡単な <code>knockout.js</code> のアプリをサンプルとして
<code>MVVM</code> の概要について解説します。</p>
<pre><code class="lang-html"><span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span> <span class="hljs-attribute">lang</span>=<span class="hljs-value">"ja"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>ko hello<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span>
    <span class="hljs-attribute">placeholder</span>=<span class="hljs-value">"お名前"</span>
    <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"value: user.name, valueUpdate: 'afterkeydown'"</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>こんにちは、<span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"text: user.name"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>さん！<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"knockout.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="http">

<span class="php"><span class="hljs-comment">// Model</span>
<span class="hljs-keyword">var</span> UserModel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">UserModel</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;

  <span class="hljs-keyword">self</span>.name = ko.observable(<span class="hljs-string">"名無し"</span>);
};

<span class="hljs-comment">// ViewModel</span>
<span class="hljs-keyword">var</span> AppViewModel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AppViewModel</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;

  <span class="hljs-keyword">self</span>.user = <span class="hljs-keyword">new</span> UserModel();
};

<span class="hljs-comment">// bind</span>
ko.applyBindings(<span class="hljs-keyword">new</span> AppViewModel());

  </span></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre>
<p>ちなみに...</p>
<pre><code class="lang-js"><span class="hljs-keyword">var</span> varName = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">funcName</span><span class="hljs-params">()</span></span>{ };
</code></pre>
<p>というのは <code>JavaScript</code>で<code>class</code> (のようなもの) を定義する際の構文です。</p>
<p>また、<code>var self = this;</code> というのは、<code>JavaScript</code>でよく使用する技法です。</p>
<p><code>JavaScript</code>では文脈によって <code>this</code> の中身が異なります (例えば、button押下時のイベントから呼び出された場合、thisにはbuttonのオブジェクトが入っています) が
<code>class</code>内部ではどのような状況であっても自分自身を取得する方法が欲しいので、 <code>new</code> した際に 自分自身を <code>self</code> という変数に格納しています。</p>
<p>以降、<code>self</code>変数を参照することで、どのような文脈からの呼び出しであっても <code>self</code> は自分自身を指します。</p>
<p><br></p>
<h4 id="-">概要</h4>
<ul>
<li><code>UserModel</code>が <em>MVVM</em> の <em>Model</em> です。</li>
<li><code>AppViewModel</code>が <em>MVVM</em> の <em>ViewModel</em> です。<ul>
<li><code>AppViewModel</code> は 変数 <code>user</code> に <em>Model</em> <code>UserModel</code> のインスタンスを一つ保持しています。</li>
</ul>
</li>
<li><code>ko</code> は <code>knockout.js</code>のオブジェクトです。</li>
<li><code>ko.applyBindings(viewModel);</code> で <code>body</code>と<code>ViewModel</code>を紐付けます。<ul>
<li>つまり、<em>MVVM</em> の <em>View</em> と <em>ViewModel</em> の紐付けを行っています。</li>
<li>HTML内の各要素に<code>data-bind</code>属性を設定することで、<em>ViewModel</em> と <em>View</em> の紐付けの詳細を定義します。</li>
</ul>
</li>
<li><code>observable</code> は該当の変数を<code>knockout.js</code>の監視対象とします。<ul>
<li>ここでは、<code>UserModel</code>の<code>name</code>の値が変わるたびに <em>ViewModel</em> を介して <em>View</em> に反映されます。</li>
</ul>
</li>
</ul>
<p>⇒ テキストボックスの値を変更すると、ほぼリアルタイムで <code>span</code>タグ内のテキストに反映されます。</p>
<p><br><br></p>
<h3 id="bookmark-list">Bookmark List</h3>
<p>すこし本格的なWebアプリケーションのサンプルを元に
もう一歩踏み込んだ <code>knockout.js</code> の機能を紹介します。</p>
<pre><code class="lang-html"><span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span> <span class="hljs-attribute">lang</span>=<span class="hljs-value">"ja"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>Bookmark List<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">style</span>&gt;</span><span class="css">
    <span class="hljs-tag">body</span><span class="hljs-rules">{
      <span class="hljs-rule"><span class="hljs-attribute">margin</span>:<span class="hljs-value"> <span class="hljs-number">40px</span></span></span>;
    }</span>
  </span><span class="hljs-tag">&lt;/<span class="hljs-title">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">table</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"table table-striped"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">thead</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">th</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"col-sm-4"</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-title">th</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">th</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"col-sm-6"</span>&gt;</span>URL<span class="hljs-tag">&lt;/<span class="hljs-title">th</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">th</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"col-sm-2"</span>&gt;</span>&amp;nbsp;<span class="hljs-tag">&lt;/<span class="hljs-title">th</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">thead</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">tbody</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"foreach: bookmarks"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">td</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"text: title"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">td</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"text: url"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">td</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-primary"</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"click: $root.currentItem"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"glyphicon glyphicon-pencil"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-danger"</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"click: $root.deleteBookmark"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"glyphicon glyphicon-trash"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">td</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">tbody</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">tfoot</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">td</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-success"</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"click: addBookmark"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"glyphicon glyphicon-plus"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">td</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">tfoot</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">table</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"panel panel-info"</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"if: currentItem"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"panel-heading"</span>&gt;</span>
      入力フォーム
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"panel-body"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-horizontal"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-group"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"txtTitle"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"col-sm-2 control-label"</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"col-sm-10"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-control"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"txtTitle"</span>
              <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"value: currentItem().title, valueUpdate: 'afterkeydown'"</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-group"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"txtUrl"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"col-sm-2 control-label"</span>&gt;</span>URL<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"col-sm-10"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-control"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"URL"</span>
              <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"value: currentItem().url, valueUpdate: 'afterkeydown'"</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"https://cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="php">
<span class="hljs-comment">/**
 * Bookmark Model
 *<span class="hljs-phpdoc"> @class</span>
 *<span class="hljs-phpdoc"> @param</span> {string} title
 *<span class="hljs-phpdoc"> @param</span> {string} url
 */</span>
<span class="hljs-keyword">var</span> BookmarkModel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(title, url)</span></span>{
  <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;

  <span class="hljs-keyword">self</span>.title = ko.observable(title);
  <span class="hljs-keyword">self</span>.url = ko.observable(url);
};

<span class="hljs-comment">/**
 * Application ViewModel
 *<span class="hljs-phpdoc"> @class</span>
 *<span class="hljs-phpdoc"> @param</span> {BookmarkModel[]}
 */</span>
<span class="hljs-keyword">var</span> AppViewModel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(models)</span></span>{
  <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;

  <span class="hljs-comment">// bookmarkのリスト</span>
  <span class="hljs-keyword">self</span>.bookmarks = ko.observableArray(models);
  <span class="hljs-comment">// 編集中のbookmark</span>
  <span class="hljs-keyword">self</span>.currentItem = ko.observable();

  <span class="hljs-comment">/**
   * [+]ボタンクリック時の処理
   * リストに空のブックマークを追加し、編集状態とする
   */</span>
  <span class="hljs-keyword">self</span>.addBookmark = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">new</span> BookmarkModel(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>);
    <span class="hljs-keyword">self</span>.bookmarks.push(model);
    <span class="hljs-keyword">self</span>.currentItem(model);
  };

  <span class="hljs-comment">/**
   * 削除処理
   * 該当ブックマークをリストから削除し、編集状態を解除する
   *<span class="hljs-phpdoc"> @param</span> {BookmarkModel} 削除対象model
   */</span>
  <span class="hljs-keyword">self</span>.deleteBookmark = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span></span>{
    <span class="hljs-keyword">self</span>.bookmarks.remove(model);
    <span class="hljs-keyword">self</span>.currentItem(<span class="hljs-keyword">null</span>);
  };
};

<span class="hljs-comment">// 初期表示データ</span>
<span class="hljs-keyword">var</span> models = [
  <span class="hljs-keyword">new</span> BookmarkModel(<span class="hljs-string">"Google"</span>, <span class="hljs-string">"http://google.com"</span>),
  <span class="hljs-keyword">new</span> BookmarkModel(<span class="hljs-string">"はてなブックマーク"</span>, <span class="hljs-string">"http://b.hatena.ne.jp/"</span>),
  <span class="hljs-keyword">new</span> BookmarkModel(<span class="hljs-string">"Qiita"</span>, <span class="hljs-string">"http://qiita.com/"</span>)
];

<span class="hljs-comment">// bind処理</span>
ko.applyBindings(<span class="hljs-keyword">new</span> AppViewModel(models));

  </span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre>
<h4 id="-">概要</h4>
<h5 id="viewmodel">ViewModel</h5>
<ul>
<li><code>ko.applyBindings</code>で <em>View</em> と <em>ViewModel</em> を紐付けます。<ul>
<li><code>AppViewModel</code>の引数に初期表示する<code>BookmarkModel</code>の配列を渡しています。</li>
</ul>
</li>
<li><code>AppViewModel</code> では受け取った配列を <code>observableArray</code> にセットします。<ul>
<li><code>observableArray</code> は配列を監視し、要素が追加/削除されると <em>View</em> に反映されます。</li>
<li>また、合わせて 編集中のbookmark を管理する <code>currentItem</code> を定義します。
<code>observable</code>定義時に引数に何も渡さないと、<code>null</code>がセットされます。</li>
<li><code>addBookmark</code>メソッドは<code>observableArray</code>に要素を追加し、追加された要素を編集中として
<code>currentItem</code>に保持します。</li>
<li><code>deleteBookmark</code>メソッドは<code>observableArray</code>から指定された要素を削除します。</li>
</ul>
</li>
</ul>
<p><br></p>
<h5 id="model">Model</h5>
<ul>
<li><code>title</code> と <code>url</code> のプロパティを持ちます。</li>
</ul>
<p><br></p>
<h5 id="view">View</h5>
<ul>
<li><code>foreach</code></li>
</ul>
<p>繰り返し処理の構文です。<br><code>foreach</code>の内側では、カレントのスコープが各アイテムになります。</p>
<p>ここでは、<code>foreach: bookmarks</code> としているので
<code>AppViewModel</code>の<code>bookmarks</code>の中身を一つづつ取り出し、処理します。</p>
<p>また、<code>bookmarks</code>は<code>observableArray</code>なので、要素が追加/削除されるたびに
<code>foreach</code>が呼び出され、配列の内容が反映されます。</p>
<p><code>$root</code>はバインドされた <em>ViewModel</em> です。
<code>$root.currentItem</code> は <code>AppViewModel</code>の<code>currentItem</code>を指します。</p>
<ul>
<li><code>click</code></li>
</ul>
<p>該当要素をクリックすると、指定された処理が実行されます。
引数にはカレントのオブジェクト (デフォルトはバインドされたViewModel、<code>foreach</code>内なら各アイテム) がセットされます。</p>
<ul>
<li><code>if</code></li>
</ul>
<p>指定された要素が <code>true</code> と判定されるような場合、該当要素が表示されます。<br>逆に、指定された要素が <code>false</code> と判定されるような場合(<code>boolean</code>の<code>false</code>、<code>string</code>の<code>&quot;&quot;</code>、<code>number</code>の<code>0</code>、<code>null</code>、<code>undefined</code>)、該当要素は非表示となります。</p>
<blockquote>
<p>if バインディングでは、対象のマークアップを物理的に追加・削除します。 したがって、配下エレメントの data-bind は if にバインドされた評価値が true のときにのみ適用されます。<br><a href="http://kojs.sukobuto.com/docs/if-binding">Knockout.js 日本語ドキュメント</a></p>
</blockquote>
<pre><code><span class="hljs-escape">`c</span>urrentItem().title<span class="hljs-escape">` </span>などで null pointer exception 的なエラーになりそうですが、
<span class="hljs-escape">`c</span>urrentItem<span class="hljs-escape">`が</span><span class="hljs-escape">`n</span>ull<span class="hljs-escape">` </span>の場合は <span class="hljs-escape">`d</span>ata-bind=<span class="hljs-string">"if: currentItem"</span><span class="hljs-escape">` </span>の要素 (子要素含む) が
<span class="hljs-escape">`D</span>OM<span class="hljs-escape">` </span>から削除されるため <span class="hljs-escape">`c</span>urrentItem().title<span class="hljs-escape">` </span>は評価されず、エラーにはなりません。
</code></pre><p><br><br></p>
<h3 id="viewmodel-">ViewModelについて</h3>
<p>今回の例は <em>ViewModel</em> がひとつですが、メニュー部分とコンテンツ部分で <em>ViewModel</em> を分割するような場合、
以下のように記述することが可能です。</p>
<pre><code class="lang-js"><span class="hljs-comment">// メニュー部分</span>
ko.applyBindings(<span class="hljs-keyword">new</span> MenuViewModel(), <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"menu"</span>));
<span class="hljs-comment">// コンテンツ部分</span>
ko.applyBindings(<span class="hljs-keyword">new</span> ContentViewModel(), <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"content"</span>));
</code></pre>
<p><br>
<br></p>
<hr>
<h1 id="todo-">ToDoアプリの開発</h1>
<h2 id="-">アプリ仕様</h2>
<p>前回作成した Web API を使用した Todoアプリケーションを作成します。</p>
<ul>
<li>画面を表示すると、Todoの一覧が表示されます。</li>
<li><code>Done</code>チェックボックスをONにすると、該当Todoがグレーアウトします。</li>
<li><code>Edit</code>ボタンをクリックすると、該当Todoを編集できます。<ul>
<li><code>Save</code>ボタンで編集内容が登録されます。</li>
<li><code>Cancel</code>ボタンで編集状態が解除されます。 (編集内容は破棄)</li>
</ul>
</li>
<li><code>Add</code>ボタンで新規Todoを登録します。</li>
</ul>
<h4 id="todo-">Todoリストの項目</h4>
<ul>
<li>id: Todoを一意に特定する数値。</li>
<li>summary: 概要。文字列。</li>
<li>detail: 詳細。文字列。</li>
<li>limit: 期限。日時。</li>
<li><p>done: 完了フラグ。真偽値。</p>
<p>  前回作成した Web API の Todo Modelと同じ内容です。</p>
</li>
</ul>
<p><br><br></p>
<hr>
<h3 id="model">model</h3>
<p>サーバーから取得したデータを格納するModel。</p>
<pre><code class="lang-js"><span class="hljs-comment">// TodoModel.js</span>
<span class="hljs-keyword">var</span> TodoModel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TodoModel</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;

  <span class="hljs-keyword">self</span>.id = ko.observable();
  <span class="hljs-keyword">self</span>.summary = ko.observable(<span class="hljs-string">""</span>);
  <span class="hljs-keyword">self</span>.detail = ko.observable(<span class="hljs-string">""</span>);
  <span class="hljs-keyword">self</span>.limit = ko.observable();
  <span class="hljs-keyword">self</span>.done = ko.observable(<span class="hljs-keyword">false</span>);
};
</code></pre>
<pre><code class="lang-js"><span class="hljs-comment">// AppViewModel.js</span>
<span class="hljs-keyword">var</span> AppViewModel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AppViewModel</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;

  <span class="hljs-keyword">self</span>.todoes = ko.observableArray();

  <span class="hljs-keyword">self</span>.todo = ko.observable();

  <span class="hljs-keyword">self</span>.addTodo = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{};

  <span class="hljs-keyword">self</span>.editTodo = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{};

  <span class="hljs-keyword">self</span>.deleteTodo = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{};

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>{}

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTodoes</span><span class="hljs-params">()</span></span>{}

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">postTodo</span><span class="hljs-params">(todo)</span></span>{}

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">putTodo</span><span class="hljs-params">(todo)</span></span>{}

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deleteTodo</span><span class="hljs-params">(todo)</span></span>{}

};
</code></pre>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="text-muted">ASP.NET勉強会 , &copy; 2015 Kazunori Kimura</p>
    </div>
  </footer>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>
  $(function(){
    $(".contents table").addClass("table");
  });
  </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29149079-3', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
